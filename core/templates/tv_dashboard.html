{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Telão - {{ tournament.nome }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #0f0f12;
            --card-bg: #1a1a20;
            --text-main: #ffffff;
            --accent: #ffb300; /* Dourado */
            --danger: #ef5350;
            --success: #66bb6a;
        }

        body {
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Oswald', sans-serif;
            height: 100vh;
            overflow: hidden; /* TV não tem scroll */
            display: flex;
            flex-direction: column;
        }
        
        @media (max-width: 768px) {
            /* Em telas pequenas (monitor/tablet), ajusta layout para coluna única */
            .main-content { grid-template-columns: 1fr; }
            .header h1 { font-size: 2vh; }
            .clock-realtime { font-size: 2vh; }
            .level-label { font-size: 3vh; }
            .blinds-display { font-size: 10vh; }
            .timer-display { font-size: 15vh; }
        }

        /* --- CABEÇALHO --- */
        .header {
            padding: 1.5vh 3vw;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.03);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .header h1 { margin: 0; font-size: 3vh; text-transform: uppercase; letter-spacing: 2px; color: #aaa; }
        .clock-realtime { font-family: 'Roboto Mono', monospace; font-size: 3vh; color: #666; }

        /* --- CORPO PRINCIPAL --- */
        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 2fr 1fr; /* Esquerda (Timer) maior que Direita (Stats) */
            gap: 2vw;
            padding: 3vw;
        }

        /* BLOCO DO TIMER (ESQUERDA) */
        .timer-section {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
            position: relative;
            border: 1px solid #333;
        }

        .level-label {
            font-size: 5vh;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 2vh;
        }

        .blinds-display {
            font-size: 15vh;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 2vh;
            text-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        
        .ante-display {
            font-size: 5vh;
            color: var(--accent);
            margin-bottom: 6vh;
        }

        .timer-display {
            font-family: 'Roboto Mono', monospace;
            font-size: 22vh; /* Gigante */
            font-weight: 700;
            line-height: 1;
            color: #fff;
            background: #000;
            padding: 2vh 4vw;
            border-radius: 15px;
            border: 2px solid #333;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
        }

        .timer-paused {
            color: var(--danger);
            animation: blink 1.5s infinite;
        }

        @keyframes blink { 50% { opacity: 0.5; } }

        /* BLOCO DE ESTATÍSTICAS (DIREITA) */
        .stats-section {
            display: flex;
            flex-direction: column;
            gap: 2vh;
        }

        .stat-card {
            flex: 1;
            background: var(--card-bg);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 1px solid #333;
        }

        .stat-label { font-size: 3vh; color: #666; text-transform: uppercase; }
        .stat-value { font-size: 8vh; font-weight: 700; color: #fff; }

        /* Rodapé / Próximo Nível */
        .footer {
            text-align: center;
            padding: 2vh;
            font-size: 3vh;
            color: #666;
            background: rgba(0,0,0,0.2);
        }
        .next-blind-val { color: #fff; font-weight: bold; margin-left: 10px; }

    </style>
</head>
<body>

    <div class="header">
        <h1>{{ tournament.nome }}</h1>
        <div class="clock-realtime" id="realTimeClock">--:--</div>
    </div>

    <div class="main-content">
        <div class="timer-section">
            <div class="level-label" id="levelName">CARREGANDO...</div>
            
            <div class="blinds-display" id="blindsVal">-- / --</div>
            <div class="ante-display" id="anteVal"></div>

            <div class="timer-display" id="mainTimer">00:00</div>
        </div>

        <div class="stats-section">
            <div class="stat-card">
                <div class="stat-label">Jogadores</div>
                <div class="stat-value" id="playersCount">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Mesas</div>
                <div class="stat-value" id="tablesCount">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Stack Médio</div>
                <div class="stat-value" id="avgStack">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Premiação</div>
                <div class="stat-value" id="prizeValue">--</div>
            </div>
        </div>
    </div>

    <div class="footer">
        PRÓXIMO NÍVEL: <span class="next-blind-val" id="nextBlind">--</span>
        &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;
        INTERVALO EM: <span class="next-blind-val" id="timeToBreak">--</span>
    </div>

    <script>
        const TOURNAMENT_ID = "{{ tournament.id }}";
        const API_URL = `/api/torneio/${TOURNAMENT_ID}/status/`;

        // Elementos do DOM
        const elTimer = document.getElementById('mainTimer');
        const elLevel = document.getElementById('levelName');
        const elBlinds = document.getElementById('blindsVal');
        const elAnte = document.getElementById('anteVal');
        const elPlayers = document.getElementById('playersCount');
        const elTables = document.getElementById('tablesCount');
        const elAvgStack = document.getElementById('avgStack');
        const elPrizeValue = document.getElementById('prizeValue');
        const elNextBlind = document.getElementById('nextBlind');
        const elTimeToBreak = document.getElementById('timeToBreak');
        
        // Estado local
        let secondsLeft = 0;
        let isPaused = true;
        let lastSyncTime = 0;

        // Formata segundos em MM:SS
        function formatTime(s) {
            if (s < 0) s = 0;
            const m = Math.floor(s / 60).toString().padStart(2, '0');
            const sec = Math.floor(s % 60).toString().padStart(2, '0');
            return `${m}:${sec}`;
        }

        // 1. Função que roda a cada 1 segundo (Countdown Visual)
        function tick() {
            if (!isPaused && secondsLeft > 0) {
                secondsLeft--;
            }
            
            elTimer.innerText = formatTime(secondsLeft);

            // Atualiza relógio de hora real no topo
            const now = new Date();
            document.getElementById('realTimeClock').innerText = 
                now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});

            if (isPaused) {
                elTimer.classList.add('timer-paused');
            } else {
                elTimer.classList.remove('timer-paused');
            }
        }

        // 2. Função que busca dados da API (Sync)
        async function syncData() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();

                // Atualiza Estado Global
                isPaused = data.is_paused;
                
                // Sincroniza o tempo (corrige drift do JS)
                // Só atualiza se a diferença for grande (>2s) para evitar "pulos" visuais feios
                if (Math.abs(secondsLeft - data.remaining_seconds) > 2) {
                    secondsLeft = data.remaining_seconds;
                }

                // Atualiza Textos
                elPlayers.innerText = data.players_count;
                elTables.innerText = data.active_tables;
                elAvgStack.innerText = data.average_stack.toLocaleString('pt-BR');

                // Premiação
                if (data.prize && data.prize.configured) {
                    const totalPrize = data.prize.total_prize.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                    elPrizeValue.innerText = `${data.prize.itm_count} pos. - ${totalPrize}`;
                } else {
                    elPrizeValue.innerText = "Não configurada";
                }

                // Tempo até próximo intervalo
                if (data.time_to_next_break) {
                    elTimeToBreak.innerText = `${data.time_to_next_break} min`;
                } else {
                    elTimeToBreak.innerText = "N/A";
                }

                // Próximo Nível
                if (data.next_level) {
                    if (data.next_level.is_break) {
                        elNextBlind.innerText = `INTERVALO (${data.next_level.tempo_minutos} min)`;
                    } else {
                        elNextBlind.innerText = `${data.next_level.small_blind}/${data.next_level.big_blind} (${data.next_level.tempo_minutos} min)`;
                    }
                } else {
                    elNextBlind.innerText = "FIM";
                }
                if (data.level) {
                    if (data.level.is_break) {
                        elLevel.innerText = "INTERVALO";
                        elLevel.style.color = "#66bb6a"; // Verde
                        elBlinds.innerText = "BREAK";
                        elAnte.innerText = "";
                    } else {
                        elLevel.innerText = `NÍVEL ${data.level.ordem}`;
                        elLevel.style.color = "#888";
                        elBlinds.innerText = `${data.level.small_blind} / ${data.level.big_blind}`;
                        
                        if (data.level.ante > 0) {
                            elAnte.innerText = `ANTE: ${data.level.ante}`;
                        } else {
                            elAnte.innerText = "";
                        }
                    }
                } else {
                    elLevel.innerText = "FIM DO TORNEIO";
                    elBlinds.innerText = "GG";
                }

            } catch (error) {
                console.error("Erro ao sincronizar:", error);
            }
        }

        // Inicia Loops
        setInterval(tick, 1000); // Roda o relógio localmente a cada 1s
        setInterval(syncData, 5000); // Sincroniza com o servidor a cada 5s
        syncData(); // Chama a primeira vez imediatamente

    </script>
</body>
</html>