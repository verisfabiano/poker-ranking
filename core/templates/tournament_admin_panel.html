{% extends "base.html" %}
{% load static %}

{% block title %}Painel Admin - {{ tournament.nome }}{% endblock %}

{% block extra_css %}
<style>
    .checklist-item {
        padding: 12px 16px;
        border-left: 4px solid #ddd;
        margin-bottom: 8px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .checklist-item.done {
        border-left-color: #28a745;
        background-color: #f0f9f5;
    }
    
    .checklist-item.pending {
        border-left-color: #ffc107;
        background-color: #fffbf0;
    }
    
    .checklist-icon {
        font-size: 1.5rem;
        min-width: 24px;
    }
    
    .progress-bar-container {
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        margin: 12px 0;
    }
    
    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        transition: width 0.3s ease;
    }
    
    .section-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .section-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 2px solid #f0f0f0;
    }
    
    .section-header h5 {
        margin: 0;
        font-weight: 600;
        color: #2c3e50;
    }
    
    .badge-lg {
        font-size: 0.95rem;
        padding: 6px 12px;
    }
    
    .stat-box {
        text-align: center;
        padding: 16px;
        background: #f8f9fa;
        border-radius: 6px;
        margin-bottom: 12px;
    }
    
    .stat-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: #2c3e50;
    }
    
    .stat-label {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 4px;
    }
    
    .results-table {
        font-size: 0.95rem;
    }
    
    .results-table input {
        font-size: 0.9rem;
    }
    
    @media (max-width: 768px) {
        .section-card {
            padding: 16px;
        }
        
        .stat-box {
            padding: 12px;
        }
        
        .stat-value {
            font-size: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <!-- HEADER -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div>
                <h1 class="h3 mb-1">
                    <i class="bi bi-sliders"></i> Painel do Torneio
                </h1>
                <h4 class="text-muted">{{ tournament.nome }}</h4>
            </div>
        </div>
        <div class="col-md-4 text-end">
            <span class="badge badge-lg bg-{{ tournament.status|lower }}">
                {{ tournament.get_status_display }}
            </span>
            <a href="{% url 'tournament_dashboard' %}" class="btn btn-outline-secondary ms-2">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    <!-- CHECKLIST DE PROGRESSO -->
    <div class="section-card">
        <div class="section-header">
            <i class="bi bi-check2-square" style="font-size: 1.5rem; color: #2c3e50;"></i>
            <h5>Checklist de Progresso</h5>
        </div>

        <!-- Barra de Progresso -->
        <div class="progress-bar-container">
            <div class="progress-bar-fill" style="width: {{ progresso_total }}%"></div>
        </div>
        <small class="text-muted">{{ progresso_total }}% conclu√≠do</small>

        <!-- Itens -->
        <div class="mt-4">
            <div class="checklist-item {% if checklist.torneio_criado %}done{% else %}pending{% endif %}">
                <div class="checklist-icon">
                    {% if checklist.torneio_criado %}<i class="bi bi-check-circle-fill text-success"></i>{% else %}<i class="bi bi-circle text-muted"></i>{% endif %}
                </div>
                <div class="flex-grow-1">
                    <strong>Torneio Criado</strong>
                    <small class="text-muted d-block">{{ tournament.data|date:"d/m/Y H:i" }}</small>
                </div>
            </div>

            <div class="checklist-item {% if checklist.jogadores_inscritos %}done{% else %}pending{% endif %}">
                <div class="checklist-icon">
                    {% if checklist.jogadores_inscritos %}<i class="bi bi-check-circle-fill text-success"></i>{% else %}<i class="bi bi-circle text-muted"></i>{% endif %}
                </div>
                <div class="flex-grow-1">
                    <strong>Jogadores Inscritos</strong>
                    <small class="text-muted d-block">{{ entries.count }} inscritos / {{ confirmados }} confirmados</small>
                </div>
                <a href="{% url 'tournament_entries_manage' tournament.id %}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-pencil"></i> Gerenciar
                </a>
            </div>

            <div class="checklist-item {% if checklist.premios_definidos %}done{% else %}pending{% endif %}">
                <div class="checklist-icon">
                    {% if checklist.premios_definidos %}<i class="bi bi-check-circle-fill text-success"></i>{% else %}<i class="bi bi-circle text-muted"></i>{% endif %}
                </div>
                <div class="flex-grow-1">
                    <strong>Estrutura de Pr√™mios Definida</strong>
                    {% if premiacao_definida %}
                    <small class="text-muted d-block">{{ pagamentos_premia|length }} posi√ß√µes configuradas</small>
                    {% else %}
                    <small class="text-muted d-block">Pendente de configura√ß√£o</small>
                    {% endif %}
                </div>
                <a href="{% url 'prize_distribution' tournament.id %}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-pencil"></i> Definir
                </a>
            </div>

            <div class="checklist-item {% if checklist.resultados_lancados %}done{% else %}pending{% endif %}">
                <div class="checklist-icon">
                    {% if checklist.resultados_lancados %}<i class="bi bi-check-circle-fill text-success"></i>{% else %}<i class="bi bi-circle text-muted"></i>{% endif %}
                </div>
                <div class="flex-grow-1">
                    <strong>Resultados Lan√ßados</strong>
                    <small class="text-muted d-block">{{ resultados_lancados }}/{{ entries.count }} posi√ß√µes preenchidas</small>
                </div>
                <a href="#resultados" class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse">
                    <i class="bi bi-pencil"></i> Lan√ßar
                </a>
            </div>

            <div class="checklist-item {% if checklist.torneio_finalizado %}done{% else %}pending{% endif %}">
                <div class="checklist-icon">
                    {% if checklist.torneio_finalizado %}<i class="bi bi-check-circle-fill text-success"></i>{% else %}<i class="bi bi-circle text-muted"></i>{% endif %}
                </div>
                <div class="flex-grow-1">
                    <strong>Torneio Finalizado</strong>
                    <small class="text-muted d-block">{% if not checklist.torneio_finalizado %}Pronto para finalizar{% else %}Encerrado{% endif %}</small>
                </div>
                {% if not checklist.torneio_finalizado %}
                <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#finalizarModal">
                    <i class="bi bi-stop-circle"></i> Finalizar
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- SE√á√ÉO: JOGADORES -->
    <div class="section-card">
        <div class="section-header">
            <i class="bi bi-people-fill" style="font-size: 1.5rem; color: #2c3e50;"></i>
            <h5>Jogadores & Inscri√ß√µes</h5>
        </div>

        <div class="row">
            <div class="col-md-3">
                <div class="stat-box">
                    <div class="stat-value">{{ entries.count }}</div>
                    <div class="stat-label">Total Inscrito</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box">
                    <div class="stat-value">{{ confirmados }}</div>
                    <div class="stat-label">Confirmados</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box">
                    <div class="stat-value">{{ entries|length|add:0|add:financeiro.rebuy_count }}</div>
                    <div class="stat-label">Rebuys</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box">
                    <div class="stat-value">{{ financeiro.addon_count }}</div>
                    <div class="stat-label">Add-ons</div>
                </div>
            </div>
        </div>

        <div class="mt-3">
            <a href="{% url 'tournament_entries_manage' tournament.id %}" class="btn btn-primary">
                <i class="bi bi-pencil"></i> Gerenciar Jogadores
            </a>
            <a href="{% url 'tournament_product_sales' tournament.id %}" class="btn btn-success">
                <i class="bi bi-gift"></i> Registrar Produtos
            </a>
        </div>
    </div>

    <!-- SE√á√ÉO: PREMIA√á√ÉO -->
    <div class="section-card">
        <div class="section-header">
            <i class="bi bi-trophy-fill" style="font-size: 1.5rem; color: #2c3e50;"></i>
            <h5>Estrutura de Pr√™mios</h5>
        </div>

        {% if premiacao_definida %}
        <div class="table-responsive">
            <table class="table table-sm mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Posi√ß√£o</th>
                        <th class="text-end">Valor</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pag in pagamentos_premia %}
                    <tr>
                        <td>
                            <strong>
                                {% if pag.position == 1 %}ü•á 1¬∫ lugar{% elif pag.position == 2 %}ü•à 2¬∫ lugar{% elif pag.position == 3 %}ü•â 3¬∫ lugar{% else %}{{ pag.position }}¬∫ lugar{% endif %}
                            </strong>
                        </td>
                        <td class="text-end">R$ {{ pag.amount|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="table-light fw-bold">
                        <td>Total</td>
                        <td class="text-end">R$ {{ prize_structure.total_prize_pool|floatformat:2 }}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        {% else %}
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> Nenhuma estrutura de pr√™mios definida
        </div>
        {% endif %}

        <div class="mt-3">
            <a href="{% url 'prize_distribution' tournament.id %}" class="btn btn-primary">
                <i class="bi bi-pencil"></i> {% if premiacao_definida %}Editar{% else %}Definir{% endif %} Pr√™mios
            </a>
        </div>
    </div>

    <!-- SE√á√ÉO: RESULTADOS -->
    <div class="section-card">
        <div class="section-header">
            <i class="bi bi-flag-fill" style="font-size: 1.5rem; color: #2c3e50;"></i>
            <h5>Lan√ßar Resultados</h5>
            <span class="badge bg-info badge-lg ms-auto">{{ resultados_lancados }}/{{ entries.count }} preenchidos</span>
        </div>

        {% if entries.count > 0 %}
        <p class="text-muted mb-3">
            <i class="bi bi-lightbulb"></i> Clique no bot√£o ao lado de cada jogador para lan√ßar seu resultado (wizard guiado).
        </p>
        
        <div class="table-responsive">
            <table class="table table-hover results-table">
                <thead class="table-light">
                    <tr>
                        <th style="width: 35%;">Jogador</th>
                        <th style="width: 15%;">Posi√ß√£o</th>
                        <th style="width: 20%;">Pr√™mio (R$)</th>
                        <th style="width: 30%;">A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in entries %}
                    {% with result=entry.tournamentresult_set.first %}
                    <tr>
                        <td class="align-middle">
                            <strong>{{ entry.player.nome }}</strong><br>
                            <small class="text-muted">{{ entry.player.apelido }}</small>
                        </td>
                        <td class="align-middle">
                            {% if result and result.posicao %}
                                <span class="badge bg-success">{{ result.posicao }}¬∫ lugar</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="align-middle">
                            {% if result and result.premiacao_recebida %}
                                <strong class="text-success">R$ {{ result.premiacao_recebida|floatformat:2 }}</strong>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="align-middle">
                            <button type="button" class="btn btn-sm btn-primary" 
                                    onclick="abrirModalResultado({{ entry.player.id }}, &quot;{{ entry.player.nome }}&quot;)">
                                <i class="bi bi-pencil-square"></i> 
                                {% if result %}Editar{% else %}Lan√ßar{% endif %}
                            </button>
                        </td>
                    </tr>
                    {% endwith %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> Nenhum jogador inscrito
        </div>
        {% endif %}
    </div>

    <!-- SE√á√ÉO: FINANCEIRO -->
    <div class="section-card">
        <div class="section-header">
            <i class="bi bi-cash-coin" style="font-size: 1.5rem; color: #2c3e50;"></i>
            <h5>Resumo Financeiro</h5>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="stat-box" style="background: #d4edda; border: 1px solid #c3e6cb;">
                    <div class="stat-value text-success">R$ {{ financeiro.faturamento_bruto|floatformat:2 }}</div>
                    <div class="stat-label">Entradas</div>
                    <small class="text-muted d-block mt-2">
                        Buy-in: R$ {{ financeiro.buyin_total|floatformat:2 }}<br>
                        Rebuys/Addons: R$ {{ financeiro.produtos_premiacao|floatformat:2 }}
                    </small>
                </div>
            </div>

            <div class="col-md-4">
                <div class="stat-box" style="background: #f8d7da; border: 1px solid #f5c6cb;">
                    <div class="stat-value text-danger">R$ {{ financeiro.premios_pagos|floatformat:2 }}</div>
                    <div class="stat-label">Premia√ß√£o</div>
                    <small class="text-muted d-block mt-2">Distribu√≠do aos vencedores</small>
                </div>
            </div>

            <div class="col-md-4">
                <div class="stat-box" style="background: #d1ecf1; border: 1px solid #bee5eb;">
                    <div class="stat-value text-info">R$ {{ financeiro.faturamento_bruto|add:financeiro.premios_pagos|stringformat:".2f" }}</div>
                    <div class="stat-label">Lucro</div>
                    <small class="text-muted d-block mt-2">Entradas - Premia√ß√£o</small>
                </div>
            </div>
        </div>

        <div class="mt-3">
            <a href="{% url 'tournament_financial' tournament.id %}" class="btn btn-outline-primary">
                <i class="bi bi-eye"></i> Ver Financeiro Completo
            </a>
        </div>
    </div>

    <!-- A√á√ïES FINAIS -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex gap-2 justify-content-between">
                <a href="{% url 'tournament_dashboard' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Voltar ao Dashboard
                </a>
                <div>
                    {% if checklist.resultados_lancados and not checklist.torneio_finalizado %}
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#finalizarModal">
                        <i class="bi bi-check-circle"></i> Finalizar Torneio
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

</div>

<!-- MODAL: FINALIZAR TORNEIO -->
<div class="modal fade" id="finalizarModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle"></i> Finalizar Torneio
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja finalizar o torneio <strong>{{ tournament.nome }}</strong>?</p>
                <p class="text-muted small">
                    Ap√≥s finalizar, o torneio ser√° marcado como encerrado e os dados n√£o poder√£o ser mais editados.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form method="post" action="{% url 'tournament_edit' tournament.id %}" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="status" value="FINALIZADO">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle"></i> Confirmar Finaliza√ß√£o
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- MODAL WIZARD: Lan√ßamento de Resultados -->
<div class="modal fade" id="modalResultadoWizard" tabindex="-1" aria-labelledby="modalResultadoTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <div>
                    <h5 class="modal-title" id="modalResultadoTitle">Lan√ßar Resultado do Torneio</h5>
                    <small class="text-muted">Jogador: <span id="playerNomeWizard">-</span></small>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Progress Indicator -->
            <div class="modal-body pt-4 pb-0">
                <div class="progress mb-4" style="height: 6px;">
                    <div id="wizardProgress" class="progress-bar bg-success" role="progressbar" style="width: 33%;" aria-valuenow="33" aria-valuemin="0" aria-valuemax="100"></div>
                </div>

                <!-- ETAPA 1: Participa√ß√£o -->
                <div id="step1" class="wizard-step active">
                    <div class="text-center mb-4">
                        <h6 class="text-secondary mb-3">Etapa 1 de 3: Participa√ß√£o</h6>
                    </div>
                    
                    <div class="row gap-3 justify-content-center">
                        <div class="col-12">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="participou" id="radioSim" value="1">
                                <label class="form-check-label fw-bold" for="radioSim">
                                    <i class="bi bi-check-circle text-success"></i> Participou e lan√ßou resultado
                                </label>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="participou" id="radioNao" value="0">
                                <label class="form-check-label fw-bold" for="radioNao">
                                    <i class="bi bi-dash-circle text-danger"></i> N√£o participou / Saiu cedo
                                </label>
                            </div>
                        </div>
                    </div>

                    <div id="naoParticipouInfo" class="alert alert-warning mt-3" style="display: none;">
                        <i class="bi bi-info-circle"></i> O jogador ser√° marcado como n√£o classificado, sem pr√™mio.
                    </div>
                </div>

                <!-- ETAPA 2: Posi√ß√£o -->
                <div id="step2" class="wizard-step" style="display: none;">
                    <div class="text-center mb-4">
                        <h6 class="text-secondary mb-3">Etapa 2 de 3: Posi√ß√£o Final</h6>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mx-auto">
                            <label for="posicaoSelect" class="form-label">Qual foi a posi√ß√£o do jogador?</label>
                            <select id="posicaoSelect" class="form-select form-select-lg">
                                <option value="">-- Selecione a posi√ß√£o --</option>
                            </select>
                            <small id="posicaoDuplicadoAlert" class="text-danger" style="display: none;">
                                <i class="bi bi-exclamation-triangle"></i> Posi√ß√£o j√° foi lan√ßada!
                            </small>
                        </div>
                    </div>
                </div>

                <!-- ETAPA 3: Pr√™mio -->
                <div id="step3" class="wizard-step" style="display: none;">
                    <div class="text-center mb-4">
                        <h6 class="text-secondary mb-3">Etapa 3 de 3: Confirma√ß√£o</h6>
                    </div>

                    <div class="row">
                        <div class="col-md-8 mx-auto">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title mb-3">Resumo do Resultado</h6>
                                    <table class="table table-sm">
                                        <tr>
                                            <th>Jogador:</th>
                                            <td id="resumoJogador">-</td>
                                        </tr>
                                        <tr>
                                            <th>Posi√ß√£o:</th>
                                            <td id="resumoPosicao">-</td>
                                        </tr>
                                        <tr class="table-success">
                                            <th>Pr√™mio (R$):</th>
                                            <td id="resumoPremio" style="font-size: 1.3rem; font-weight: bold;">R$ 0,00</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" id="btnAnterior" style="display: none;">
                    <i class="bi bi-chevron-left"></i> Anterior
                </button>
                <button type="button" class="btn btn-primary" id="btnProximo">
                    Pr√≥ximo <i class="bi bi-chevron-right"></i>
                </button>
                <button type="button" class="btn btn-success" id="btnSalvar" style="display: none;">
                    <i class="bi bi-save"></i> Salvar Resultado
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Estilos adicionais para o wizard -->
<style>
    .wizard-step {
        min-height: 200px;
        animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .wizard-step.active {
        display: block;
    }

    #radioSim, #radioNao {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }
</style>

<!-- Script para o wizard -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentStep = 1;
    let wizardData = {
        player_id: null,
        tournament_id: {{ tournament.id }},
        participou: null,
        posicao: null,
        premio: 0
    };

    // Elementos do modal
    const modal = new bootstrap.Modal(document.getElementById('modalResultadoWizard'));
    const btnProximo = document.getElementById('btnProximo');
    const btnAnterior = document.getElementById('btnAnterior');
    const btnSalvar = document.getElementById('btnSalvar');

    // Radio buttons de participa√ß√£o
    const radioSim = document.getElementById('radioSim');
    const radioNao = document.getElementById('radioNao');

    // Select de posi√ß√£o
    const posicaoSelect = document.getElementById('posicaoSelect');

    // Event listeners para participa√ß√£o
    radioSim.addEventListener('change', function() {
        if (this.checked) {
            wizardData.participou = true;
            document.getElementById('naoParticipouInfo').style.display = 'none';
        }
    });

    radioNao.addEventListener('change', function() {
        if (this.checked) {
            wizardData.participou = false;
            document.getElementById('naoParticipouInfo').style.display = 'block';
        }
    });

    // Validar posi√ß√£o duplicada
    posicaoSelect.addEventListener('change', function() {
        const posicao = this.value;
        if (!posicao) return;

        // Simular valida√ß√£o (em produ√ß√£o, fazer fetch)
        const jaUsada = wizardData.posicoes_ja_lancadas && 
                       wizardData.posicoes_ja_lancadas.includes(parseInt(posicao));
        
        const alertElement = document.getElementById('posicaoDuplicadoAlert');
        if (jaUsada) {
            alertElement.style.display = 'block';
        } else {
            alertElement.style.display = 'none';
            wizardData.posicao = posicao;
        }
    });

    // Bot√£o Pr√≥ximo
    btnProximo.addEventListener('click', function() {
        if (!validarStep(currentStep)) return;
        
        currentStep++;
        if (currentStep > 3) currentStep = 3;
        
        renderStep();
    });

    // Bot√£o Anterior
    btnAnterior.addEventListener('click', function() {
        currentStep--;
        if (currentStep < 1) currentStep = 1;
        
        renderStep();
    });

    // Bot√£o Salvar
    btnSalvar.addEventListener('click', function() {
        salvarResultado();
    });

    function validarStep(step) {
        if (step === 1) {
            if (wizardData.participou === null) {
                alert('Selecione se o jogador participou!');
                return false;
            }
            // Se n√£o participou, pular direto para confirmar
            if (!wizardData.participou) {
                currentStep = 3;
                renderStep();
                return false;
            }
        } else if (step === 2) {
            if (!wizardData.posicao) {
                alert('Selecione a posi√ß√£o do jogador!');
                return false;
            }
        }
        return true;
    }

    function renderStep() {
        // Esconder todos os steps
        document.querySelectorAll('.wizard-step').forEach(el => {
            el.style.display = 'none';
        });

        // Mostrar step atual
        document.getElementById(`step${currentStep}`).style.display = 'block';

        // Atualizar progress bar
        const progress = (currentStep / 3) * 100;
        document.getElementById('wizardProgress').style.width = progress + '%';

        // Atualizar bot√µes
        btnAnterior.style.display = currentStep > 1 ? 'block' : 'none';
        btnProximo.style.display = currentStep < 3 ? 'block' : 'none';
        btnSalvar.style.display = currentStep === 3 ? 'block' : 'none';

        // Se step 3, carregar dados para resumo
        if (currentStep === 3) {
            atualizarResumo();
        }
    }

    function atualizarResumo() {
        const nomeElement = document.getElementById('resumoJogador');
        const posicaoElement = document.getElementById('resumoPosicao');
        const premioElement = document.getElementById('resumoPremio');

        if (wizardData.participou === false) {
            nomeElement.textContent = document.getElementById('playerNomeWizard').textContent;
            posicaoElement.textContent = 'N√£o participou';
            premioElement.textContent = 'R$ 0,00';
        } else {
            nomeElement.textContent = document.getElementById('playerNomeWizard').textContent;
            
            // Buscar nome da posi√ß√£o e pr√™mio
            const selectedOption = posicaoSelect.options[posicaoSelect.selectedIndex];
            if (selectedOption.text) {
                posicaoElement.textContent = selectedOption.text;
            }
            
            // Buscar pr√™mio do objeto premios
            if (wizardData.premios_disponiveis) {
                const premio = wizardData.premios_disponiveis.find(p => 
                    p.posicao === parseInt(wizardData.posicao)
                );
                if (premio) {
                    wizardData.premio = premio.valor;
                    premioElement.textContent = 'R$ ' + premio.valor.toFixed(2).replace('.', ',');
                }
            }
        }
    }

    function salvarResultado() {
        const formData = new FormData();
        formData.append('player_id', wizardData.player_id);
        formData.append('posicao', wizardData.participou ? wizardData.posicao : null);
        formData.append('premio', wizardData.premio);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        fetch(`/api/torneio/${wizardData.tournament_id}/resultado/salvar/`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Resultado salvo com sucesso!');
                modal.hide();
                // Recarregar a p√°gina para atualizar tabela
                location.reload();
            } else {
                alert('Erro ao salvar: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro de conex√£o ao salvar resultado');
        });
    }

    // Fun√ß√£o para abrir modal com dados de um jogador
    window.abrirModalResultado = function(playerId, playerNome) {
        wizardData.player_id = playerId;
        
        // Resetar form
        currentStep = 1;
        wizardData.participou = null;
        wizardData.posicao = null;
        document.getElementById('radioSim').checked = false;
        document.getElementById('radioNao').checked = false;
        posicaoSelect.value = '';

        // Atualizar nome do jogador
        document.getElementById('playerNomeWizard').textContent = playerNome;

        // Carregar dados do jogador via AJAX
        fetch(`/api/torneio/${wizardData.tournament_id}/jogador/${playerId}/modal-resultado/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Carregar pr√™mios no select
                    posicaoSelect.innerHTML = '<option value="">-- Selecione a posi√ß√£o --</option>';
                    data.premios_disponiveis.forEach(premio => {
                        const option = document.createElement('option');
                        option.value = premio.posicao;
                        option.textContent = premio.display;
                        posicaoSelect.appendChild(option);
                    });

                    // Armazenar dados para valida√ß√£o
                    wizardData.premios_disponiveis = data.premios_disponiveis;
                    wizardData.posicoes_ja_lancadas = data.posicoes_ja_lancadas;

                    // Se j√° tem resultado, carregar dados
                    if (data.resultado.existe) {
                        if (data.resultado.posicao) {
                            document.getElementById('radioSim').checked = true;
                            posicaoSelect.value = data.resultado.posicao;
                        } else {
                            document.getElementById('radioNao').checked = true;
                        }
                    }
                }
                
                // Renderizar step 1
                renderStep();
                modal.show();
            })
            .catch(error => {
                console.error('Erro ao carregar dados:', error);
                alert('Erro ao carregar dados do jogador');
            });
    };
});
</script>

{% endblock %}

