{% extends 'base.html' %}

{% block title %}Novo Torneio - Wizard{% endblock %}

{% block breadcrumb-items %}
    <li class="breadcrumb-item"><a href="/temporadas/">Temporadas</a></li>
    <li class="breadcrumb-item"><a href="/season/{{ season.id }}/torneios/">{{ season.nome }}</a></li>
    <li class="breadcrumb-item active">Novo Torneio</li>
{% endblock %}

{% block extra_css %}
<style>
    .wizard-step {
        display: none;
        animation: fadeIn 0.3s;
    }

    .wizard-step.active {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .wizard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 8px;
        padding: 30px;
        margin-bottom: 30px;
    }

    .progress-wrapper {
        margin-bottom: 30px;
    }

    .progress {
        height: 8px;
        background-color: #e9ecef;
        border-radius: 4px;
    }

    .progress-bar {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        transition: width 0.3s ease;
    }

    .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-top: 12px;
        font-size: 0.85rem;
    }

    .step-number {
        display: inline-block;
        width: 24px;
        height: 24px;
        background: #e9ecef;
        border-radius: 50%;
        text-align: center;
        line-height: 24px;
        font-weight: bold;
        margin-right: 8px;
    }

    .step-number.active {
        background: #667eea;
        color: white;
    }

    .step-number.done {
        background: #28a745;
        color: white;
    }

    .form-section {
        background: white;
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border-left: 4px solid #667eea;
    }

    .form-section h5 {
        color: #2c3e50;
        margin-bottom: 20px;
    }

    .form-help {
        display: block;
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 4px;
    }

    .field-required::after {
        content: " *";
        color: #dc3545;
    }

    .btn-group .btn-check:checked + .btn {
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.25);
    }

    .card-summary {
        background: #f8f9fa;
        border-left: 4px solid #667eea;
        padding: 16px;
        border-radius: 4px;
        margin-bottom: 12px;
    }

    .card-summary-label {
        font-size: 0.85rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .card-summary-value {
        font-size: 1.3rem;
        font-weight: bold;
        color: #2c3e50;
        margin-top: 4px;
    }

    .modal-footer {
        display: flex;
        gap: 8px;
        justify-content: space-between;
    }

    .modal-footer {
        display: flex;
        gap: 8px;
        justify-content: space-between;
    }

    .btn-navigation {
        min-width: 140px;
    }

    /* ============================================================
       MOBILE OPTIMIZATION - Phase 4
       ============================================================ */
    
    @media (max-width: 768px) {
        /* Modal responsivo */
        .modal-lg,
        .modal-dialog {
            max-width: 95vw;
            margin: 10px auto;
        }
        
        .modal-content {
            border-radius: 12px;
        }
        
        .modal-header,
        .modal-body,
        .modal-footer {
            padding: 16px;
        }
        
        .modal-header h5 {
            font-size: 1.1rem;
        }
        
        /* Aumentar touch targets */
        .btn {
            min-height: 44px;
            padding: 10px 16px;
            font-size: 0.95rem;
        }
        
        .form-check-input,
        .form-select,
        .form-control {
            min-height: 44px;
            font-size: 16px; /* Evita zoom iOS */
        }
        
        /* Form sections */
        .form-section {
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .form-section h5 {
            font-size: 1rem;
            margin-bottom: 16px;
        }
        
        /* Botões no footer */
        .modal-footer {
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }
        
        .modal-footer .btn {
            flex: 0 1 auto;
            min-width: 120px;
            min-height: 44px;
        }
        
        .btn-navigation {
            min-width: 100px;
            flex: 1;
        }
        
        /* Card summary */
        .card-summary {
            padding: 12px;
            margin-bottom: 10px;
        }
        
        .card-summary-value {
            font-size: 1.1rem;
        }
        
        /* Progress bar */
        .step-indicator {
            font-size: 0.8rem;
            gap: 4px;
        }
        
        .step-number {
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            line-height: 20px;
        }
        
        /* Input groups */
        .input-group {
            flex-direction: column;
        }
        
        .input-group .input-group-text {
            border-radius: 4px 4px 0 0;
            padding: 8px;
        }
        
        .input-group .form-control {
            border-radius: 0 0 4px 4px;
            border-top: none;
        }
        
        /* Row spacing */
        .row > [class*=col-] {
            padding-left: 8px;
            padding-right: 8px;
        }
        
        .g-3 {
            gap: 12px !important;
        }
        
        /* Badges */
        .badge-lg {
            font-size: 0.85rem;
            padding: 6px 12px;
        }
        
        /* Wizard header */
        .wizard-header {
            padding: 20px;
            border-radius: 8px;
        }
        
        .wizard-header h2 {
            font-size: 1.3rem;
        }
    }
    
    @media (max-width: 480px) {
        /* Extra small screens */
        .modal-dialog {
            max-width: 100vw;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-content {
            border-radius: 0;
            margin: 0;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            flex-shrink: 0;
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .modal-body {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 12px;
        }
        
        .modal-footer {
            flex-shrink: 0;
            padding: 12px;
            border-top: 1px solid #dee2e6;
        }
        
        .form-section {
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 4px;
        }
        
        .form-section h5 {
            font-size: 0.95rem;
            margin-bottom: 12px;
        }
        
        .btn {
            font-size: 0.9rem;
            padding: 8px 12px;
            min-height: 40px;
        }
        
        .btn-navigation {
            min-width: 90px;
            flex: 1;
            min-height: 40px;
            font-size: 0.85rem;
        }
        
        /* Stack columns */
        .col-md-6,
        .col-md-8 {
            flex: 0 0 100%;
            max-width: 100%;
        }
        
        .row > [class*=col-] {
            padding-left: 0;
            padding-right: 0;
        }
        
        /* Full width inputs */
        .input-group {
            width: 100%;
        }
        
        .form-control,
        .form-select {
            width: 100%;
        }
        
        /* Progress indicator mobile */
        .progress {
            height: 4px;
        }
        
        .step-indicator {
            font-size: 0.7rem;
            justify-content: space-around;
        }
        
        .step-number {
            width: 18px;
            height: 18px;
            font-size: 0.65rem;
            line-height: 18px;
        }
        
        /* Card summary compact */
        .card-summary {
            padding: 10px;
            margin-bottom: 8px;
        }
        
        .card-summary-label {
            font-size: 0.75rem;
        }
        
        .card-summary-value {
            font-size: 0.95rem;
            margin-top: 2px;
        }
        
        /* Checkboxes larger */
        .form-check {
            padding-left: 0;
            margin-bottom: 12px;
        }
        
        .form-check-input {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            cursor: pointer;
        }
        
        .form-check-label {
            margin-bottom: 0;
            cursor: pointer;
            padding-top: 2px;
        }
        
        /* Alert boxes */
        .alert {
            padding: 12px;
            font-size: 0.9rem;
            margin-bottom: 12px;
        }
        
        /* Readable text */
        body {
            font-size: 14px;
        }
        
        h1, h2, h3, h4, h5, h6 {
            line-height: 1.3;
        }
    }
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            
            <!-- HEADER -->
            <div class="wizard-header">
                <h2 class="mb-2">
                    <i class="bi bi-plus-circle-dotted"></i> Criar Novo Torneio
                </h2>
                <p class="mb-0 opacity-75">Temporada: <strong>{{ season.nome }}</strong></p>
            </div>

            <!-- WIZARD MODAL -->
            <button class="btn btn-primary btn-lg w-100 mb-4" onclick="abrirWizardTorneio()">
                <i class="bi bi-magic"></i> Abrir Assistente Guiado (Wizard)
            </button>

            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <strong>Dica:</strong> Use o assistente guiado para criar seu torneio passo-a-passo! 
                Ou <a href="/season/{{ season.id }}/torneios/novo/#form-tradicional">pule para o formulário tradicional</a>.
            </div>

        </div>
    </div>
</div>

<!-- MODAL WIZARD: Criar Torneio -->
<div class="modal fade" id="wizardTournamentModal" tabindex="-1" aria-labelledby="wizardTitle" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <!-- HEADER -->
            <div class="modal-header bg-light">
                <div>
                    <h5 class="modal-title" id="wizardTitle">Criar Novo Torneio</h5>
                    <small class="text-muted">Passo <span id="stepCounter">1</span> de 4</small>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- PROGRESS BAR -->
            <div class="modal-body pb-0">
                <div class="progress-wrapper">
                    <div class="progress">
                        <div id="wizardProgress" class="progress-bar" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="step-indicator">
                        <span><span class="step-number active" id="step1-num">1</span>Básico</span>
                        <span><span class="step-number" id="step2-num">2</span>Valores</span>
                        <span><span class="step-number" id="step3-num">3</span>Avançado</span>
                        <span><span class="step-number" id="step4-num">4</span>Revisão</span>
                    </div>
                </div>

                <!-- STEP 1: BÁSICO -->
                <div id="step1" class="wizard-step active">
                    <div class="form-section">
                        <h5>Informações Básicas</h5>
                        
                        <div class="mb-3">
                            <label for="wizardNome" class="form-label field-required">Nome do Torneio</label>
                            <input type="text" class="form-control" id="wizardNome" placeholder="Ex: Terça Turbo 10K" required>
                            <div class="form-help"><i class="bi bi-lightbulb"></i> Escolha um nome descritivo</div>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="wizardData" class="form-label field-required">Data</label>
                                <input type="date" class="form-control" id="wizardData" required>
                            </div>
                            <div class="col-md-6">
                                <label for="wizardHora" class="form-label field-required">Hora</label>
                                <input type="time" class="form-control" id="wizardHora" required>
                            </div>
                        </div>

                        {% if season.tipo_calculo == 'FIXO' %}
                        <div class="mt-3">
                            <label for="wizardTipo" class="form-label field-required">Tipo de Torneio</label>
                            <select class="form-select" id="wizardTipo" required>
                                <option value="">-- Selecione o tipo --</option>
                            </select>
                            <div class="form-help"><i class="bi bi-info-circle"></i> Define o multiplicador de pontos</div>
                        </div>
                        {% else %}
                        <div class="alert alert-info alert-sm mt-3">
                            <i class="bi bi-info-circle"></i> Esta temporada usa pontuação dinâmica
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- STEP 2: VALORES -->
                <div id="step2" class="wizard-step">
                    <div class="form-section">
                        <h5>Buy-in e Taxa</h5>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="wizardBuyin" class="form-label field-required">Buy-in (R$)</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" step="0.01" class="form-control" id="wizardBuyin" placeholder="100.00" required>
                                </div>
                                <div class="form-help">Valor que cada jogador paga</div>
                            </div>
                            <div class="col-md-6">
                                <label for="wizardBuyinChips" class="form-label">Fichas</label>
                                <input type="number" class="form-control" id="wizardBuyinChips" placeholder="10000">
                                <div class="form-help">Quantidade de fichas (opcional)</div>
                            </div>
                        </div>

                        <!-- RAKE TYPE -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Como calcular o rake?</label>
                            <div class="btn-group w-100 d-flex" role="group">
                                <input type="radio" class="btn-check rake-type-toggle" name="wizardRakeType" id="rakeFixo" value="FIXO">
                                <label class="btn btn-outline-primary flex-grow-1" for="rakeFixo">
                                    <i class="bi bi-cash"></i> Fixo
                                </label>

                                <input type="radio" class="btn-check rake-type-toggle" name="wizardRakeType" id="rakePercentual" value="PERCENTUAL" checked>
                                <label class="btn btn-outline-primary flex-grow-1" for="rakePercentual">
                                    <i class="bi bi-percent"></i> Percentual
                                </label>

                                <input type="radio" class="btn-check rake-type-toggle" name="wizardRakeType" id="rakeMisto" value="MISTO">
                                <label class="btn btn-outline-primary flex-grow-1" for="rakeMisto">
                                    <i class="bi bi-stack"></i> Misto
                                </label>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="wizardRakeValor" class="form-label field-required">Valor do Rake</label>
                            <div class="input-group">
                                <input type="number" step="0.01" class="form-control" id="wizardRakeValor" placeholder="10">
                                <span class="input-group-text" id="rakeTypeLabel">%</span>
                            </div>
                            <div class="form-help">
                                <i class="bi bi-info-circle"></i> 
                                Pote estimado: <strong id="poteEstimado">R$ 90,00</strong>
                            </div>
                        </div>

                        <!-- REBUY / ADDON -->
                        <hr>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="wizardPermiteRebuy">
                            <label class="form-check-label fw-bold" for="wizardPermiteRebuy">
                                Permitir Rebuy?
                            </label>
                        </div>

                        <div id="rebuyFields" style="display: none;" class="mb-3">
                            <label for="wizardRebuyValor" class="form-label">Valor Rebuy (R$)</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number" step="0.01" class="form-control" id="wizardRebuyValor" placeholder="100.00">
                            </div>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="wizardPermiteAddon">
                            <label class="form-check-label fw-bold" for="wizardPermiteAddon">
                                Permitir Add-on?
                            </label>
                        </div>

                        <div id="addonFields" style="display: none;" class="mb-3">
                            <label for="wizardAddonValor" class="form-label">Valor Add-on (R$)</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number" step="0.01" class="form-control" id="wizardAddonValor" placeholder="100.00">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- STEP 3: AVANÇADO -->
                <div id="step3" class="wizard-step">
                    <div class="form-section">
                        <h5>Configurações Avançadas</h5>
                        
                        <div class="mb-4">
                            <label for="wizardBlindStructure" class="form-label">Estrutura de Blinds</label>
                            <select class="form-select" id="wizardBlindStructure">
                                <option value="">-- Sem estrutura pré-definida --</option>
                            </select>
                            <div class="form-help">Opcional: Define a progressão de blinds</div>
                        </div>

                        <hr>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="wizardStaffObrigatorio">
                            <label class="form-check-label fw-bold" for="wizardStaffObrigatorio">
                                Staff Obrigatório?
                            </label>
                        </div>

                        <div id="staffFields" style="display: none;" class="mb-3">
                            <label for="wizardStaffValor" class="form-label">Valor Staff (R$)</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number" step="0.01" class="form-control" id="wizardStaffValor" placeholder="20.00">
                            </div>
                        </div>

                        <hr>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Produtos Inclusos</label>
                            <div id="produtosCheckboxes" style="max-height: 200px; overflow-y: auto;">
                                <!-- Preenchido por JavaScript -->
                            </div>
                            <div class="form-help"><i class="bi bi-info-circle"></i> Selecione quais produtos estarão disponíveis</div>
                        </div>
                    </div>
                </div>

                <!-- STEP 4: REVISÃO -->
                <div id="step4" class="wizard-step">
                    <div class="form-section">
                        <h5>Confirme os Dados</h5>
                        
                        <!-- Seção Básico -->
                        <div class="card-summary">
                            <div class="card-summary-label">Básico</div>
                            <div class="card-summary-value" id="reviewNome">-</div>
                            <small class="text-muted" id="reviewDataHora">-</small>
                        </div>

                        <!-- Seção Financeiro -->
                        <div class="card-summary">
                            <div class="card-summary-label">Financeiro por Jogador</div>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <small>Buy-in:</small><br>
                                    <strong id="reviewBuyin">R$ 0,00</strong>
                                </div>
                                <div class="col-md-6">
                                    <small>Rake:</small><br>
                                    <strong id="reviewRake">R$ 0,00</strong>
                                </div>
                            </div>
                            <div class="mt-2 pt-2 border-top">
                                <small>Pote (Premiação):</small><br>
                                <strong class="text-success" id="reviewPote">R$ 0,00</strong>
                            </div>
                        </div>

                        <!-- Seção Opcionais -->
                        <div class="card-summary" id="reviewOpcionais" style="display: none;">
                            <div class="card-summary-label">Opcionais Ativados</div>
                            <div id="reviewOpcionaisConteudo" class="mt-2"></div>
                        </div>

                        <div class="alert alert-success mt-3">
                            <i class="bi bi-check-circle"></i>
                            <strong>Pronto!</strong> Clique em "Criar Torneio" para confirmar.
                        </div>
                    </div>
                </div>

            </div>

            <!-- FOOTER -->
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary btn-navigation" id="btnAnterior" style="display: none;">
                    <i class="bi bi-chevron-left"></i> Anterior
                </button>
                <button type="button" class="btn btn-primary btn-navigation" id="btnProximo">
                    Próximo <i class="bi bi-chevron-right"></i>
                </button>
                <button type="button" class="btn btn-success btn-navigation" id="btnCriar" style="display: none;">
                    <i class="bi bi-check-lg"></i> Criar Torneio
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts do Wizard -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentStep = 1;
    const seasonId = {{ season.id }};
    
    const wizardData = {
        nome: '',
        data: '',
        tipo_id: '{{ season.tipo_calculo }}' === 'FIXO' ? '' : null,
        buyin: 0,
        buyin_chips: 0,
        rake_type: 'PERCENTUAL',
        rake_valor: 0,
        permite_rebuy: false,
        rebuy_valor: 0,
        permite_rebuy_duplo: false,
        rebuy_duplo_valor: 0,
        permite_addon: false,
        addon_valor: 0,
        blind_structure_id: null,
        staff_obrigatorio: false,
        staff_valor: 0,
        timechip_chips: 0,
        produtos_ids: []
    };

    // Elementos DOM
    const btnProximo = document.getElementById('btnProximo');
    const btnAnterior = document.getElementById('btnAnterior');
    const btnCriar = document.getElementById('btnCriar');
    const wizardModal = new bootstrap.Modal(document.getElementById('wizardTournamentModal'));

    // Form inputs
    const inputNome = document.getElementById('wizardNome');
    const inputData = document.getElementById('wizardData');
    const inputHora = document.getElementById('wizardHora');
    const inputTipo = document.getElementById('wizardTipo');
    const inputBuyin = document.getElementById('wizardBuyin');
    const inputBuyinChips = document.getElementById('wizardBuyinChips');
    const selectRakeType = document.querySelectorAll('input[name="wizardRakeType"]');
    const inputRakeValor = document.getElementById('wizardRakeValor');
    const chkRebuy = document.getElementById('wizardPermiteRebuy');
    const chkAddon = document.getElementById('wizardPermiteAddon');
    const chkStaff = document.getElementById('wizardStaffObrigatorio');

    // Event listeners para Rebuy/Addon/Staff
    chkRebuy.addEventListener('change', function() {
        document.getElementById('rebuyFields').style.display = this.checked ? 'block' : 'none';
        wizardData.permite_rebuy = this.checked;
    });

    chkAddon.addEventListener('change', function() {
        document.getElementById('addonFields').style.display = this.checked ? 'block' : 'none';
        wizardData.permite_addon = this.checked;
    });

    chkStaff.addEventListener('change', function() {
        document.getElementById('staffFields').style.display = this.checked ? 'block' : 'none';
        wizardData.staff_obrigatorio = this.checked;
    });

    // Event listeners para rake
    selectRakeType.forEach(radio => {
        radio.addEventListener('change', function() {
            wizardData.rake_type = this.value;
            const label = document.getElementById('rakeTypeLabel');
            label.textContent = this.value === 'PERCENTUAL' ? '%' : 'R$';
            calcularPote();
        });
    });

    inputBuyin.addEventListener('change', calcularPote);
    inputRakeValor.addEventListener('change', calcularPote);

    function calcularPote() {
        const buyin = parseFloat(inputBuyin.value) || 0;
        const rake = parseFloat(inputRakeValor.value) || 0;
        
        let pote;
        if (wizardData.rake_type === 'PERCENTUAL') {
            pote = buyin * (1 - rake / 100);
        } else {
            pote = buyin - rake;
        }
        
        document.getElementById('poteEstimado').textContent = 'R$ ' + pote.toFixed(2).replace('.', ',');
    }

    // Botões navegação
    btnProximo.addEventListener('click', proximoStep);
    btnAnterior.addEventListener('click', anteriorStep);
    btnCriar.addEventListener('click', criarTorneio);

    function proximoStep() {
        if (!validarStep(currentStep)) return;
        
        currentStep++;
        if (currentStep > 4) currentStep = 4;
        
        renderStep();
    }

    function anteriorStep() {
        currentStep--;
        if (currentStep < 1) currentStep = 1;
        
        renderStep();
    }

    function validarStep(step) {
        if (step === 1) {
            if (!inputNome.value.trim() || inputNome.value.trim().length < 3) {
                alert('Nome deve ter mínimo 3 caracteres');
                return false;
            }
            if (!inputData.value || !inputHora.value) {
                alert('Data e hora são obrigatórias');
                return false;
            }
            if ('{{ season.tipo_calculo }}' === 'FIXO' && !inputTipo.value) {
                alert('Tipo de torneio é obrigatório');
                return false;
            }
            
            // Montar datetime
            const dataHora = `${inputData.value}T${inputHora.value}`;
            wizardData.nome = inputNome.value.trim();
            wizardData.data = dataHora;
            wizardData.tipo_id = inputTipo.value || null;
            
        } else if (step === 2) {
            const buyin = parseFloat(inputBuyin.value) || 0;
            if (buyin <= 0) {
                alert('Buy-in deve ser maior que 0');
                return false;
            }
            
            const rake = parseFloat(inputRakeValor.value) || 0;
            if (rake < 0) {
                alert('Rake não pode ser negativo');
                return false;
            }
            
            wizardData.buyin = buyin;
            wizardData.buyin_chips = parseInt(inputBuyinChips.value) || 0;
            wizardData.rake_valor = rake;
            if (chkRebuy.checked) {
                wizardData.rebuy_valor = parseFloat(document.getElementById('wizardRebuyValor').value) || 0;
            }
            if (chkAddon.checked) {
                wizardData.addon_valor = parseFloat(document.getElementById('wizardAddonValor').value) || 0;
            }
            
        } else if (step === 3) {
            if (chkStaff.checked) {
                wizardData.staff_valor = parseFloat(document.getElementById('wizardStaffValor').value) || 0;
                if (wizardData.staff_valor <= 0) {
                    alert('Staff obrigatório deve ter valor > 0');
                    return false;
                }
            }
            
            // Carregar dados avançados
            wizardData.blind_structure_id = document.getElementById('wizardBlindStructure').value || null;
            
            // Produtos selecionados
            wizardData.produtos_ids = Array.from(document.querySelectorAll('input[name="produto"]:checked')).map(el => parseInt(el.value));
        }
        
        return true;
    }

    function renderStep() {
        // Esconder todos os steps
        document.querySelectorAll('.wizard-step').forEach(el => {
            el.classList.remove('active');
        });

        // Mostrar step atual
        document.getElementById(`step${currentStep}`).classList.add('active');

        // Atualizar progress
        const progress = (currentStep / 4) * 100;
        document.getElementById('wizardProgress').style.width = progress + '%';
        document.getElementById('stepCounter').textContent = currentStep;

        // Atualizar números dos steps
        for (let i = 1; i <= 4; i++) {
            const num = document.getElementById(`step${i}-num`);
            if (i === currentStep) {
                num.classList.remove('done');
                num.classList.add('active');
            } else if (i < currentStep) {
                num.classList.add('done');
                num.classList.remove('active');
            } else {
                num.classList.remove('done', 'active');
            }
        }

        // Atualizar botões
        btnAnterior.style.display = currentStep > 1 ? 'block' : 'none';
        btnProximo.style.display = currentStep < 4 ? 'block' : 'none';
        btnCriar.style.display = currentStep === 4 ? 'block' : 'none';

        // Se step 4, renderizar resumo
        if (currentStep === 4) {
            renderResumo();
        } else if (currentStep === 1) {
            carregarTipos();
        } else if (currentStep === 3) {
            carregarBlindStructures();
            carregarProdutos();
        }
    }

    function carregarTipos() {
        if ('{{ season.tipo_calculo }}' !== 'FIXO') return;
        
        fetch(`/api/season/${seasonId}/tournament/wizard/step/1/`)
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const html = '<option value="">-- Selecione o tipo --</option>' +
                        data.tipos.map(t => `<option value="${t.id}">${t.nome} (x${t.multiplicador_pontos})</option>`).join('');
                    inputTipo.innerHTML = html;
                }
            });
    }

    function carregarBlindStructures() {
        fetch(`/api/season/${seasonId}/tournament/wizard/step/3/`)
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const select = document.getElementById('wizardBlindStructure');
                    const html = '<option value="">-- Nenhuma --</option>' +
                        data.blind_structures.map(b => `<option value="${b.id}">${b.nome}</option>`).join('');
                    select.innerHTML = html;
                }
            });
    }

    function carregarProdutos() {
        fetch(`/api/season/${seasonId}/tournament/wizard/step/3/`)
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const html = data.produtos.map(p => `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="produto" value="${p.id}" id="produto${p.id}">
                            <label class="form-check-label" for="produto${p.id}">
                                ${p.nome} <small class="text-muted">(R$ ${p.valor.toFixed(2)})</small>
                            </label>
                        </div>
                    `).join('');
                    document.getElementById('produtosCheckboxes').innerHTML = html;
                    
                    // Re-attach listener para checkboxes de produtos
                    document.querySelectorAll('input[name="produto"]').forEach(chk => {
                        chk.addEventListener('change', function() {
                            wizardData.produtos_ids = Array.from(document.querySelectorAll('input[name="produto"]:checked')).map(el => parseInt(el.value));
                        });
                    });
                }
            });
    }

    function renderResumo() {
        // Básico
        document.getElementById('reviewNome').textContent = wizardData.nome;
        document.getElementById('reviewDataHora').textContent = new Date(wizardData.data).toLocaleString('pt-BR');

        // Financeiro
        document.getElementById('reviewBuyin').textContent = `R$ ${wizardData.buyin.toFixed(2).replace('.', ',')}`;
        
        let rakeCalc;
        if (wizardData.rake_type === 'PERCENTUAL') {
            rakeCalc = wizardData.buyin * (wizardData.rake_valor / 100);
        } else {
            rakeCalc = wizardData.rake_valor;
        }
        document.getElementById('reviewRake').textContent = `R$ ${rakeCalc.toFixed(2).replace('.', ',')}`;
        
        const pote = wizardData.buyin - rakeCalc;
        document.getElementById('reviewPote').textContent = `R$ ${pote.toFixed(2).replace('.', ',')}`;

        // Opcionais
        const opcionais = [];
        if (wizardData.permite_rebuy) opcionais.push(`Rebuy: R$ ${wizardData.rebuy_valor.toFixed(2).replace('.', ',')}`);
        if (wizardData.permite_addon) opcionais.push(`Add-on: R$ ${wizardData.addon_valor.toFixed(2).replace('.', ',')}`);
        if (wizardData.staff_obrigatorio) opcionais.push(`Staff: R$ ${wizardData.staff_valor.toFixed(2).replace('.', ',')}`);

        if (opcionais.length > 0) {
            document.getElementById('reviewOpcionais').style.display = 'block';
            document.getElementById('reviewOpcionaisConteudo').innerHTML = opcionais.map(o => `<div>✓ ${o}</div>`).join('');
        }
    }

    function criarTorneio() {
        if (!validarStep(3)) return; // Última validação

        btnCriar.disabled = true;
        btnCriar.innerHTML = '<i class="bi bi-hourglass-split"></i> Criando...';

        fetch(`/api/season/${seasonId}/tournament/wizard/save/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(wizardData)
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('Torneio criado com sucesso!');
                window.location.href = data.redirect_url;
            } else {
                alert('Erro: ' + data.message);
                btnCriar.disabled = false;
                btnCriar.innerHTML = '<i class="bi bi-check-lg"></i> Criar Torneio';
            }
        })
        .catch(err => {
            console.error(err);
            alert('Erro ao criar torneio');
            btnCriar.disabled = false;
            btnCriar.innerHTML = '<i class="bi bi-check-lg"></i> Criar Torneio';
        });
    }

    // Abrir wizard
    window.abrirWizardTorneio = function() {
        currentStep = 1;
        wizardModal.show();
        renderStep();
    };
});
</script>

{% endblock %}
