{% extends 'base.html' %}

{% block title %}
    {% if tournament %}Editar Torneio{% else %}Novo Torneio{% endif %}
{% endblock %}

{% block breadcrumb-items %}
    <li class="breadcrumb-item"><a href="{% url 'seasons_list' %}">Temporadas</a></li>
    <li class="breadcrumb-item"><a href="{% url 'season_tournaments' season.id %}">{{ season.nome }}</a></li>
    <li class="breadcrumb-item active">{% if tournament %}Editar{% else %}Novo Torneio{% endif %}</li>
{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background: white;
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border-left: 4px solid var(--primary);
    }
    
    .form-section h5 {
        color: var(--primary);
        margin-bottom: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .form-label {
        font-weight: 500;
        color: #212529;
        margin-bottom: 8px;
    }
    
    .form-help {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 4px;
        display: block;
    }
    
    .field-required::after {
        content: " *";
        color: #ef5350;
    }
    
    .alert-validation {
        background: #fff3cd;
        border-color: #ffc107;
        color: #856404;
        border-radius: 6px;
        padding: 12px 16px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .input-group-text {
        background-color: #f8f9fa;
        border-color: #dee2e6;
    }
    
    /* Garantir que inputs do form s√£o clic√°veis */
    .form-control,
    input[type="number"],
    input[type="text"],
    input[type="email"],
    input[type="datetime-local"],
    input[type="checkbox"],
    input[type="radio"],
    select,
    textarea {
        pointer-events: auto !important;
        user-select: text !important;
        z-index: auto !important;
    }
    
    /* Espec√≠fico para o campo staff_valor */
    #staff_valor {
        pointer-events: auto !important;
        user-select: text !important;
        z-index: auto !important;
        position: relative !important;
    }
    
    .btn-action {
        padding: 10px 24px;
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .rake-type-selector {
        display: none;
        padding: 16px;
        background: #f8f9fa;
        border-radius: 6px;
        margin-top: 12px;
    }
    
    .rake-type-selector.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            
            <!-- HEADER FORM -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; padding: 30px; margin-bottom: 30px;">
                <h2 class="mb-2">
                    <i class="bi {% if tournament %}bi-pencil-square{% else %}bi-plus-circle-dotted{% endif %}"></i>
                    {% if tournament %}Editar Torneio{% else %}Agendar Novo Torneio{% endif %}
                </h2>
                <p class="mb-0 opacity-75">Temporada: <strong>{{ season.nome }}</strong></p>
            </div>

            {% if season.tipo_calculo == "DINAMICO" %}
            <div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
                <i class="bi bi-info-circle-fill"></i>
                <strong>Pontua√ß√£o Din√¢mica Ativa:</strong> Esta temporada usa pontua√ß√£o inteligente baseada no tamanho do campo, buy-in e posi√ß√£o final. 
                O tipo de torneio n√£o afeta a pontua√ß√£o neste modo.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            <form method="POST" novalidate>
                {% csrf_token %}

                <!-- SE√á√ÉO 1: INFORMA√á√ïES B√ÅSICAS -->
                <div class="form-section">
                    <h5><i class="bi bi-info-circle"></i> Informa√ß√µes B√°sicas</h5>
                    
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="nome" class="form-label field-required">Nome do Torneio</label>
                            <input type="text" class="form-control" id="nome" name="nome" 
                                   value="{{ tournament.nome|default:'' }}" required 
                                   placeholder="Ex: Ter√ßa Turbo 10K">
                            <span class="form-help">
                                <i class="bi bi-lightbulb"></i> Use um nome descritivo para identificar facilmente
                            </span>
                        </div>
                        <div class="col-md-3">
                            <label for="data" class="form-label field-required">Data e Hora</label>
                            <input type="datetime-local" class="form-control" id="data" name="data" 
                                   value="{{ data_str|default:'' }}" required>
                        </div>
                        {% if season.tipo_calculo == "FIXO" %}
                        <div class="col-md-3">
                            <label for="tipo_id" class="form-label field-required">
                                Tipo (Pontua√ß√£o)
                                <i class="bi bi-question-circle tooltip-icon" data-bs-toggle="tooltip" 
                                   title="Afeta o multiplicador de pontos no modo FIXO de pontua√ß√£o"></i>
                            </label>
                            <select class="form-select" id="tipo_id" name="tipo_id" required>
                                <option value="">-- Selecione --</option>
                                {% for tipo in tipos %}
                                <option value="{{ tipo.id }}" {% if tournament.tipo_id == tipo.id %}selected{% endif %}>
                                    {{ tipo.nome }} (x{{ tipo.multiplicador_pontos }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        {% else %}
                        <input type="hidden" id="tipo_id" name="tipo_id" value="">
                        {% endif %}
                    </div>
                </div>

                <!-- SE√á√ÉO 2: BUY-IN & RAKE -->
                <div class="form-section">
                    <h5><i class="bi bi-cash-coin"></i> Valores - Buy-in e Taxa</h5>
                    
                    <div class="alert-validation">
                        <i class="bi bi-info-circle-fill"></i>
                        <div>
                            <strong>Como funciona:</strong> O buy-in √© dividido entre o <strong>pote</strong> (premia√ß√£o) e o <strong>rake</strong> (taxa da casa).
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label for="buyin" class="form-label field-required">Valor Buy-in (Total)</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number" step="0.01" class="form-control" id="buyin" name="buyin" 
                                       value="{{ buyin_str }}" required 
                                       placeholder="0.00">
                            </div>
                            <span class="form-help">Valor que cada jogador paga</span>
                        </div>
                        <div class="col-md-4">
                            <label for="buyin_chips" class="form-label">Fichas do Buy-in</label>
                            <input type="number" class="form-control" id="buyin_chips" name="buyin_chips" 
                                   value="{{ tournament.buyin_chips|default:'' }}" 
                                   placeholder="Ex: 10000">
                            <span class="form-help">Quantidade de fichas por buy-in</span>
                        </div>
                    </div>

                    <!-- RAKE TYPE SELECTOR -->
                    <div class="row g-3 mb-3 p-3 bg-light border rounded">
                        <div class="col-12">
                            <label class="form-label fw-bold mb-3">Como calcular o Rake?</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check rake-toggle" name="rake_type" id="rake_fixo" 
                                       value="FIXO" {% if tournament.rake_type == 'FIXO' %}checked{% endif %}>
                                <label class="btn btn-outline-primary" for="rake_fixo">
                                    <i class="bi bi-cash"></i> Valor Fixo
                                </label>

                                <input type="radio" class="btn-check rake-toggle" name="rake_type" id="rake_percentual" 
                                       value="PERCENTUAL" {% if tournament.rake_type == 'PERCENTUAL' or not tournament.rake_type %}checked{% endif %}>
                                <label class="btn btn-outline-primary" for="rake_percentual">
                                    <i class="bi bi-percent"></i> Percentual
                                </label>

                                <input type="radio" class="btn-check rake-toggle" name="rake_type" id="rake_misto" 
                                       value="MISTO" {% if tournament.rake_type == 'MISTO' %}checked{% endif %}>
                                <label class="btn btn-outline-primary" for="rake_misto">
                                    <i class="bi bi-stack"></i> Fixo + %
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Rake Fixo -->
                    <div id="rake_fixo_fields" class="rake-type-selector {% if tournament.rake_type == 'FIXO' %}active{% endif %}">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="rake_valor" class="form-label">Valor do Rake</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" step="0.01" class="form-control" id="rake_valor" name="rake_valor" 
                                           value="{{ rake_valor_str }}" placeholder="0.00">
                                </div>
                                <span class="form-help">Ex: R$ 10 √© a taxa fixa por jogador</span>
                            </div>
                        </div>
                    </div>

                    <!-- Rake Percentual -->
                    <div id="rake_percentual_fields" class="rake-type-selector {% if tournament.rake_type == 'PERCENTUAL' or not tournament.rake_type %}active{% endif %}">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="rake_percentual" class="form-label">% do Buy-in</label>
                                <div class="input-group">
                                    <input type="number" step="0.01" class="form-control" id="rake_percentual" name="rake_percentual" 
                                           value="{{ rake_percentual_str }}" placeholder="0.00">
                                    <span class="input-group-text">%</span>
                                </div>
                                <span class="form-help">Ex: 10% de R$ 100 = R$ 10 de rake</span>
                            </div>
                        </div>
                    </div>

                    <!-- Rake Misto -->
                    <div id="rake_misto_fields" class="rake-type-selector {% if tournament.rake_type == 'MISTO' %}active{% endif %}">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="rake_valor_m" class="form-label">Valor Fixo</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" step="0.01" class="form-control" id="rake_valor_m" name="rake_valor_m" 
                                           value="{{ rake_valor_str }}" placeholder="0.00">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="rake_percentual_m" class="form-label">+ Percentual</label>
                                <div class="input-group">
                                    <input type="number" step="0.01" class="form-control" id="rake_percentual_m" name="rake_percentual_m" 
                                           value="{{ rake_percentual_str }}" placeholder="0.00">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SE√á√ÉO 3: REBUY, ADD-ON, PRODUCTS -->
                <div class="form-section">
                    <h5><i class="bi bi-arrow-repeat"></i> Rebuy, Add-on & Produtos</h5>
                    
                    <div class="row g-3 mb-4">
                        <!-- REBUY SIMPLES -->
                        <div class="col-md-6">
                            <div class="card border-warning">
                                <div class="card-header bg-warning bg-opacity-10">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="permite_rebuy" name="permite_rebuy"
                                               {% if tournament.permite_rebuy or not tournament %}checked{% endif %}>
                                        <label class="form-check-label fw-bold" for="permite_rebuy">
                                            REBUY SIMPLES
                                        </label>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <label for="rebuy_valor" class="form-label">Valor do Rebuy</label>
                                    <div class="input-group">
                                        <span class="input-group-text">R$</span>
                                        <input type="number" step="0.01" class="form-control" id="rebuy_valor" name="rebuy_valor" 
                                               value="{{ rebuy_valor_str }}" placeholder="0.00">
                                    </div>
                                    <label for="rebuy_chips" class="form-label mt-2">Fichas do Rebuy</label>
                                    <input type="number" class="form-control" id="rebuy_chips" name="rebuy_chips" 
                                           value="{{ tournament.rebuy_chips|default:'' }}" placeholder="Ex: 5000">
                                    <small class="form-text text-muted">Permite quantidade ilimitada</small>
                                </div>
                            </div>
                        </div>

                        <!-- REBUY DUPLO -->
                        <div class="col-md-6">
                            <div class="card border-warning">
                                <div class="card-header bg-warning bg-opacity-10">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="permite_rebuy_duplo" name="permite_rebuy_duplo"
                                               {% if tournament.permite_rebuy_duplo %}checked{% endif %}>
                                        <label class="form-check-label fw-bold" for="permite_rebuy_duplo">
                                            REBUY DUPLO (2x ou diferenciado)
                                        </label>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <label for="rebuy_duplo_valor" class="form-label">Valor do Rebuy Duplo</label>
                                    <div class="input-group">
                                        <span class="input-group-text">R$</span>
                                        <input type="number" step="0.01" class="form-control" id="rebuy_duplo_valor" name="rebuy_duplo_valor" 
                                               value="{{ rebuy_duplo_valor_str }}" placeholder="2x rebuy simples">
                                    </div>
                                    <label for="rebuy_duplo_chips" class="form-label mt-2">Fichas do Rebuy Duplo</label>
                                    <input type="number" class="form-control" id="rebuy_duplo_chips" name="rebuy_duplo_chips" 
                                           value="{{ tournament.rebuy_duplo_chips|default:'' }}" placeholder="Ex: 10000">
                                    <small class="form-text text-muted">Se vazio, ser√° 2x o rebuy simples</small>
                                </div>
                            </div>
                        </div>

                        <!-- ADD-ON -->
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-header bg-info bg-opacity-10">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="permite_addon" name="permite_addon"
                                               {% if tournament.permite_addon or not tournament %}checked{% endif %}>
                                        <label class="form-check-label fw-bold" for="permite_addon">
                                            ADD-ON (m√°x. 1x)
                                        </label>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <label for="addon_valor" class="form-label">Valor do Add-on</label>
                                    <div class="input-group">
                                        <span class="input-group-text">R$</span>
                                        <input type="number" step="0.01" class="form-control" id="addon_valor" name="addon_valor" 
                                               value="{{ addon_valor_str }}" placeholder="0.00">
                                    </div>
                                    <label for="addon_chips" class="form-label mt-2">Fichas do Add-on</label>
                                    <input type="number" class="form-control" id="addon_chips" name="addon_chips" 
                                           value="{{ tournament.addon_chips|default:'' }}" placeholder="Ex: 5000">
                                    <small class="form-text text-muted">M√°ximo 1 por jogador (geralmente na pausa)</small>
                                </div>
                            </div>
                        </div>

                        <!-- STAFF -->
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-header bg-success bg-opacity-10">
                                    <label class="form-check-label fw-bold">STAFF</label>
                                </div>
                                <div class="card-body">
                                    <label for="staff_valor" class="form-label">Valor do STAFF</label>
                                    <div class="input-group mb-3">
                                        <span class="input-group-text">R$</span>
                                        <input type="number" step="0.01" class="form-control" id="staff_valor" name="staff_valor" 
                                               value="{{ staff_valor_str }}" placeholder="0.00">
                                    </div>
                                    <label for="staff_chips" class="form-label">Fichas do STAFF (se houver)</label>
                                    <input type="number" class="form-control" id="staff_chips" name="staff_chips" 
                                           value="{{ tournament.staff_chips|default:'' }}" placeholder="Ex: 2000">
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox" id="staff_obrigatorio" name="staff_obrigatorio"
                                               {% if tournament.staff_obrigatorio or not tournament %}checked{% endif %}>
                                        <label class="form-check-label" for="staff_obrigatorio">
                                            STAFF Obrigat√≥rio no Buy-in?
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- TIME CHIP -->
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-header bg-info bg-opacity-10">
                                    <label class="form-check-label fw-bold">TIME CHIP</label>
                                </div>
                                <div class="card-body">
                                    <label for="timechip_chips" class="form-label">Fichas do Time Chip</label>
                                    <input type="number" class="form-control" id="timechip_chips" name="timechip_chips" 
                                           value="{{ tournament.timechip_chips|default:'' }}" placeholder="Ex: 5000">
                                    <small class="form-text text-muted">Fichas confirmadas pelo diretor quando jogador chega a tempo</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>

                <!-- SE√á√ÉO 4: ESTRUTURA -->
                <div class="form-section">
                    <h5><i class="bi bi-diagram-3"></i> Estrutura do Torneio</h5>
                    
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="stack_inicial" class="form-label">Stack Inicial</label>
                            <input type="number" class="form-control" id="stack_inicial" name="stack_inicial" 
                                   value="{{ tournament.stack_inicial|default:'10000' }}">
                            <span class="form-help">Fichas que cada jogador recebe</span>
                        </div>

                        <div class="col-md-3">
                            <label for="garantido" class="form-label">Garantido</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number" step="0.01" class="form-control" id="garantido" name="garantido" 
                                       value="{{ tournament.garantido|floatformat:2|default:'' }}" placeholder="0,00">
                            </div>
                        </div>

                        <div class="col-md-3">
                            <label for="max_players_per_table" class="form-label">M√°x. Jogadores/Mesa</label>
                            <input type="number" class="form-control" id="max_players_per_table" name="max_players_per_table" 
                                   value="{{ tournament.max_players_per_table|default:'9' }}">
                        </div>

                        <div class="col-md-3">
                            <label for="blind_structure" class="form-label">Estrutura Blinds</label>
                            <select class="form-select" id="blind_structure" name="blind_structure" 
                                    onchange="updateBlindPreview()"
                                    {% if tournament.id and tournament.status != 'AGENDADO' %}disabled{% endif %}>
                                <option value="">-- Sem estrutura --</option>
                                {% for blind_struct in blind_structures %}
                                <option value="{{ blind_struct.id }}" 
                                        {% if tournament.blind_structure_id == blind_struct.id %}selected{% endif %}>
                                    {{ blind_struct.nome }} ({{ blind_struct.levels.count }} n√≠veis)
                                </option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">
                                {% if tournament.id and tournament.status != 'AGENDADO' %}
                                    <span class="badge bg-warning">Estrutura de blinds n√£o pode ser alterada ap√≥s o torneio come√ßar</span>
                                {% else %}
                                    Para editar blinds, acesse <a href="{% url 'blind_structures_list' %}" target="_blank">Gerenciamento de Blinds</a>
                                {% endif %}
                            </small>
                        </div>

                        <!-- Preview das Blinds -->
                        <div class="col-md-12" id="blind-preview" style="display: none;">
                            <div class="alert alert-info" role="alert">
                                <strong>Estrutura de Blinds Selecionada:</strong>
                                <div id="blind-levels" style="margin-top: 10px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SE√á√ÉO 5: STATUS -->
                <div class="form-section">
                    <h5><i class="bi bi-toggle-on"></i> Status</h5>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="status" class="form-label">Status do Evento</label>
                            <select class="form-select" id="status" name="status">
                                <option value="AGENDADO" {% if tournament.status == 'AGENDADO' or not tournament.status %}selected{% endif %}>
                                    üìÖ Agendado
                                </option>
                                <option value="EM_ANDAMENTO" {% if tournament.status == 'EM_ANDAMENTO' %}selected{% endif %}>
                                    ‚ñ∂Ô∏è Em Andamento
                                </option>
                                <option value="FINALIZADO" {% if tournament.status == 'FINALIZADO' %}selected{% endif %}>
                                    ‚úÖ Finalizado
                                </option>
                                <option value="CANCELADO" {% if tournament.status == 'CANCELADO' %}selected{% endif %}>
                                    ‚ùå Cancelado
                                </option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- GERADOR DE POSTERS -->
                {% if tournament.id %}
                <div class="form-section">
                    <h5><i class="bi bi-image"></i> Gerador de Posters para Divulga√ß√£o</h5>
                    
                    <div class="alert alert-info mb-3" role="alert">
                        <i class="bi bi-lightbulb"></i> Gere imagens para compartilhar nas redes sociais. Escolha o template e tema que mais combinam com o estilo do seu clube.
                    </div>
                    
                    <div class="row g-3">
                        <!-- Templates -->
                        <div class="col-12 mb-3">
                            <label class="form-label fw-600">Template</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="poster-template" id="template-feed" value="feed" checked>
                                <label class="btn btn-outline-primary" for="template-feed">
                                    <i class="bi bi-square"></i> Feed (1080x1440)
                                </label>
                                
                                <input type="radio" class="btn-check" name="poster-template" id="template-story" value="story">
                                <label class="btn btn-outline-primary" for="template-story">
                                    <i class="bi bi-phone"></i> Story (1080x1920)
                                </label>
                                
                                <input type="radio" class="btn-check" name="poster-template" id="template-horizontal" value="horizontal">
                                <label class="btn btn-outline-primary" for="template-horizontal">
                                    <i class="bi bi-landscape"></i> Horizontal (1920x1080)
                                </label>
                            </div>
                        </div>
                        
                        <!-- Temas -->
                        <div class="col-12 mb-3">
                            <label class="form-label fw-600">Tema</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="poster-theme" id="theme-gold" value="gold" checked>
                                <label class="btn btn-outline-warning" for="theme-gold">
                                    <i class="bi bi-star-fill text-warning"></i> Gold (Premium)
                                </label>
                                
                                <input type="radio" class="btn-check" name="poster-theme" id="theme-dark" value="dark">
                                <label class="btn btn-outline-secondary" for="theme-dark">
                                    <i class="bi bi-moon-stars-fill text-dark"></i> Dark (Moderno)
                                </label>
                                
                                <input type="radio" class="btn-check" name="poster-theme" id="theme-neon" value="neon">
                                <label class="btn btn-outline-info" for="theme-neon">
                                    <i class="bi bi-lightning-fill text-info"></i> Neon (Vibrante)
                                </label>
                            </div>
                        </div>
                        
                        <!-- Formatos -->
                        <div class="col-12">
                            <label class="form-label fw-600">Formato</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="poster-format" id="format-png" value="png" checked>
                                <label class="btn btn-outline-secondary" for="format-png">
                                    PNG (Melhor qualidade)
                                </label>
                                
                                <input type="radio" class="btn-check" name="poster-format" id="format-jpg" value="jpg">
                                <label class="btn btn-outline-secondary" for="format-jpg">
                                    JPG (Menor tamanho)
                                </label>
                            </div>
                        </div>
                        
                        <!-- Bot√µes de a√ß√£o -->
                        <div class="col-12 mt-3 pt-2">
                            <div class="d-grid gap-2 d-sm-flex">
                                <button type="button" class="btn btn-info btn-sm" onclick="previewPoster(this)">
                                    <i class="bi bi-eye"></i> Visualizar
                                </button>
                                <button type="button" class="btn btn-success btn-sm" onclick="downloadPoster(this)">
                                    <i class="bi bi-download"></i> Baixar
                                </button>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="openInNewTab(this)">
                                    <i class="bi bi-share"></i> Abrir em Nova Aba
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-info" role="alert">
                    <i class="bi bi-info-circle"></i> <strong>Dica:</strong> Ap√≥s criar o torneio, voc√™ poder√° gerar posters para divulga√ß√£o!
                </div>
                {% endif %}

                <!-- BOT√ïES DE A√á√ÉO -->
                <div class="d-flex justify-content-between gap-2 mt-4">
                    <a href="{% url 'season_tournaments' season.id %}" class="btn btn-outline-secondary btn-action">
                        <i class="bi bi-arrow-left"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary btn-action">
                        <i class="bi bi-check-lg"></i> SALVAR TORNEIO
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Fechar qualquer popover aberto quando o usu√°rio tentar clicar em um input
            document.querySelectorAll('input, select, textarea').forEach(element => {
                element.addEventListener('focus', function() {
                    // Fechar todos os popovers abertos
                    document.querySelectorAll('.popover').forEach(pop => {
                        pop.remove();
                    });
                });
            });
            
            // Valida√ß√£o: tipo_id √© obrigat√≥rio apenas em modo FIXO
            const tipoField = document.getElementById('tipo_id');
            const form = document.querySelector('form');
            
            if (form) {
                form.addEventListener('submit', function(e) {
                    // Se o campo tipo est√° vis√≠vel (modo FIXO), deve estar preenchido
                    if (tipoField && tipoField.offsetParent !== null && !tipoField.value) {
                        e.preventDefault();
                        tipoField.classList.add('is-invalid');
                        tipoField.focus();
                        return false;
                    }
                });
            }
            
            // Toggle entre tipos de rake
            const rakeToggles = document.querySelectorAll('.rake-toggle');
            
            rakeToggles.forEach(toggle => {
                toggle.addEventListener('change', function() {
                    document.getElementById('rake_fixo_fields').classList.remove('active');
                    document.getElementById('rake_percentual_fields').classList.remove('active');
                    document.getElementById('rake_misto_fields').classList.remove('active');
                    
                    if (this.value === 'FIXO') {
                        document.getElementById('rake_fixo_fields').classList.add('active');
                    } else if (this.value === 'PERCENTUAL') {
                        document.getElementById('rake_percentual_fields').classList.add('active');
                    } else if (this.value === 'MISTO') {
                        document.getElementById('rake_misto_fields').classList.add('active');
                    }
                });
            });

            // Fun√ß√£o para atualizar preview de blinds
            window.updateBlindPreview = function() {
                const blindSelect = document.getElementById('blind_structure');
                const selectedOption = blindSelect.options[blindSelect.selectedIndex];
                const blindPreview = document.getElementById('blind-preview');
                const blindLevels = document.getElementById('blind-levels');
                
                if (blindSelect.value) {
                    // Mostrar preview (em um caso real, buscaria via API)
                    const levelCount = selectedOption.text.match(/\((\d+) n√≠veis\)/);
                    if (levelCount) {
                        blindLevels.innerHTML = '<p><strong>' + selectedOption.text.split('(')[0].trim() + '</strong> com ' + levelCount[1] + ' n√≠veis de blind</p>';
                        blindPreview.style.display = 'block';
                    }
                } else {
                    blindPreview.style.display = 'none';
                }
            };

            // Atualizar preview ao carregar
            if (document.getElementById('blind_structure').value) {
                updateBlindPreview();
            }
        });

        // Fun√ß√µes para gerar posters
        function getPosterUrl() {
            const tournamentId = "{{ tournament.id|default:'null' }}";
            const template = document.querySelector('input[name="poster-template"]:checked').value;
            const theme = document.querySelector('input[name="poster-theme"]:checked').value;
            const format = document.querySelector('input[name="poster-format"]:checked').value;
            
            return `/torneio/${tournamentId}/poster/?template=${template}&theme=${theme}&format=${format}`;
        }

        function previewPoster(btn) {
            const url = getPosterUrl();
            const modal = new bootstrap.Modal(document.createElement('div'));
            
            // Criar modal customizado
            const modalHtml = `
                <div class="modal fade" id="posterPreviewModal" tabindex="-1">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-light">
                                <h5 class="modal-title"><i class="bi bi-image"></i> Visualizar Poster</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center p-0">
                                <img src="${url}" class="img-fluid" alt="Poster Preview" style="max-height: 80vh;">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                <a href="${url}" download class="btn btn-success">
                                    <i class="bi bi-download"></i> Baixar
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remover modal anterior se existir
            const oldModal = document.getElementById('posterPreviewModal');
            if (oldModal) oldModal.remove();
            
            // Adicionar novo modal
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const newModal = new bootstrap.Modal(document.getElementById('posterPreviewModal'));
            newModal.show();
        }

        function downloadPoster(btn) {
            const url = getPosterUrl();
            const tournamentId = "{{ tournament.id|default:'null' }}";
            const template = document.querySelector('input[name="poster-template"]:checked').value;
            const format = document.querySelector('input[name="poster-format"]:checked').value;
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `poster_torneio_${tournamentId}_${template}.${format}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function openInNewTab(btn) {
            const url = getPosterUrl();
            window.open(url, '_blank');
        }
    </script>
{% endblock %}