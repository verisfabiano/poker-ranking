{% extends 'base.html' %}

{% block title %}Inscrições - {{ tournament.nome }}{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <div class="d-flex justify-content-between align-items-center mb-4 mt-2">
        <div>
            <h2 class="mb-1">Jogadores do Torneio</h2>
            <div class="text-muted">
                {{ tournament.nome }} 
                {% if tournament.status == "AGENDADO" %}
                    <span class="badge bg-success ms-2">Agendado</span>
                {% elif tournament.status == "EM_ANDAMENTO" %}
                    <span class="badge bg-warning text-dark ms-2">Em Andamento</span>
                {% elif tournament.status == "FINALIZADO" %}
                    <span class="badge bg-danger ms-2">Finalizado</span>
                {% endif %}
            </div>
        </div>
        <a href="{% url 'season_tournaments' season.id %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Voltar
        </a>
    </div>

    {% if mensagem %}
        <div class="alert alert-success d-flex align-items-center" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i> {{ mensagem }}
        </div>
    {% endif %}
    {% if mensagem_erro %}
        <div class="alert alert-danger d-flex align-items-center" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> {{ mensagem_erro }}
        </div>
    {% endif %}
    {% if edicao_bloqueada %}
        <div class="alert alert-warning d-flex align-items-center" role="alert">
            <i class="bi bi-lock-fill me-2"></i> Torneio finalizado ou em andamento. Edição bloqueada.
        </div>
    {% endif %}

    <form method="POST">
        {% csrf_token %}

        <div class="row g-4">
            
            <div class="col-lg-8">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i> Lista de Inscritos</h5>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-center" style="width: 50px;">
                                        <i class="bi bi-trash"></i>
                                    </th>
                                    <th>Jogador</th>
                                    <th>Solicitação</th>
                                    <th class="text-center">Confirmado?</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in entries %}
                                    <tr class="{% if entry.confirmado_pelo_admin %}table-success-subtle{% elif entry.confirmou_presenca %}table-warning-subtle{% endif %}">
                                        <td class="text-center">
                                            <input class="form-check-input border-danger" type="checkbox" name="remover_entry_id" value="{{ entry.id }}" 
                                                   {% if edicao_bloqueada %}disabled{% endif %}>
                                        </td>
                                        <td>
                                            <span class="fw-bold text-dark">{{ entry.player.nome }}</span>
                                            {% if entry.player.apelido %}
                                                <small class="text-muted d-block">({{ entry.player.apelido }})</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if entry.confirmou_presenca %}
                                                <span class="badge text-bg-warning">Pediu vaga</span>
                                            {% else %}
                                                <span class="text-muted small">Inserido pelo Admin</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            <div class="form-check form-switch d-inline-block">
                                                <input class="form-check-input" type="checkbox" name="conf_admin_{{ entry.id }}" 
                                                       {% if entry.confirmado_pelo_admin %}checked{% endif %}
                                                       {% if edicao_bloqueada %}disabled{% endif %}>
                                            </div>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center py-5 text-muted">
                                            Nenhum jogador inscrito neste torneio.
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="card-footer bg-light d-flex justify-content-between p-3 flex-wrap gap-2">
                        <button type="submit" name="remove_selected" class="btn btn-outline-danger btn-sm"
                                onclick="return confirm('Remover os jogadores selecionados?');"
                                {% if edicao_bloqueada %}disabled{% endif %}>
                            <i class="bi bi-trash"></i> Remover Selecionados
                        </button>

                        <div class="d-flex gap-2">
                            <button type="submit" name="confirm_all_requests" class="btn btn-warning btn-sm fw-bold text-dark"
                                    {% if edicao_bloqueada %}disabled{% endif %}>
                                <i class="bi bi-check-all"></i> Confirmar Pedidos
                            </button>
                            <button type="submit" name="save_admin_confirm" class="btn btn-primary btn-sm fw-bold"
                                    {% if edicao_bloqueada %}disabled{% endif %}>
                                <i class="bi bi-save"></i> Salvar Alterações
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm border-0 sticky-top" style="top: 20px;">
                    <div class="card-header bg-success text-white py-3">
                        <h5 class="mb-0"><i class="bi bi-person-plus-fill me-2"></i> Adicionar Manualmente</h5>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted mb-3">Insira um jogador diretamente no torneio (sem que ele precise pedir).</p>
                        
                        <div class="mb-3">
                            <label for="novo_player_id" class="form-label fw-bold">Selecione o Jogador</label>
                            <select class="form-select" name="novo_player_id" id="novo_player_id" {% if edicao_bloqueada %}disabled{% endif %}>
                                <option value="">Buscar jogador...</option>
                                {% for p in players_disponiveis %}
                                    <option value="{{ p.id }}">{{ p.nome }} {% if p.apelido %}({{ p.apelido }}){% endif %}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="d-grid">
                            <button type="submit" name="add_player" class="btn btn-success fw-bold"
                                    {% if edicao_bloqueada %}disabled{% endif %}>
                                <i class="bi bi-plus-lg"></i> Adicionar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </form>
</div>
{% endblock %}