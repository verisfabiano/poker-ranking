{% extends 'base.html' %}

{% block title %}Inscrições - {{ tournament.nome }}{% endblock %}

{% block extra_css %}
<style>
    .table-responsive {
        overflow: visible !important;
    }
    .products-badge {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
        padding: 4px 0;
    }
    .product-badge {
        font-size: 0.75rem;
        padding: 2px 6px;
    }
    
    /* Esconder tags de produtos que são REBUY, ADDON, STAFF, REBUY_DUPLO */
    .product-badge:has-text("REBUY"),
    .product-badge:has-text("ADDON"),
    .product-badge:has-text("STAFF"),
    .product-badge:contains("REBUY"),
    .product-badge:contains("ADDON"),
    .product-badge:contains("STAFF") {
        display: none !important;
    }
    
    .products-popover {
        max-width: 300px;
    }
    
    /* Modais com z-index altíssimo */
    #modalNovoJogador {
        z-index: 9999 !important;
        pointer-events: auto !important;
    }
    #modalNovoJogador.modal {
        pointer-events: auto !important;
    }
    #modalNovoJogador .modal-dialog {
        pointer-events: auto !important;
        z-index: 9999 !important;
        max-height: calc(100vh - 40px) !important;
        margin-top: 50px !important;
    }
    #modalNovoJogador .modal-content {
        pointer-events: auto !important;
        z-index: 9999 !important;
        max-height: calc(100vh - 40px) !important;
    }
    
    /* Modal body scrollável */
    #modalNovoJogador .modal-body {
        max-height: calc(100vh - 200px) !important;
        overflow-y: auto !important;
        pointer-events: auto !important;
    }
    
    /* Remover backdrop que bloqueia */
    .modal-backdrop {
        display: none !important;
    }
    
    /* Garantir todos os elementos dentro do modal */
    #modalNovoJogador * {
        pointer-events: auto !important;
    }
    
    #modalNovoJogador input,
    #modalNovoJogador textarea,
    #modalNovoJogador select,
    #modalNovoJogador button,
    #modalNovoJogador label,
    #modalNovoJogador .form-control,
    #modalNovoJogador .form-check-input {
        pointer-events: auto !important;
        user-select: text !important;
    }
</style>
{% endblock %}

{% block content %}
<script type="text/javascript">
    // Dados do torneio - renderizados como objeto JavaScript
    (function() {
        'use strict';
        window.tournamentData = {
            id: {{ tournament.id }},
            nome: "{{ tournament.nome|escapejs }}",
            rebuy_valor: {{ tournament.rebuy_valor|default:0|floatformat:2 }},
            rebuy_duplo_valor: {{ tournament.rebuy_duplo_valor|default:0|floatformat:2 }},
            addon_valor: {{ tournament.addon_valor|default:0|floatformat:2 }},
            permite_rebuy: {{ tournament.permite_rebuy|lower }},
            permite_rebuy_duplo: {{ tournament.permite_rebuy_duplo|lower }},
            permite_addon: {{ tournament.permite_addon|lower }},
            timechip_chips: {{ tournament.timechip_chips|default:0 }}
        };
    }());
</script>

<div class="container-fluid">
    
    <div class="d-flex justify-content-between align-items-center mb-4 mt-2">
        <div>
            <h2 class="mb-1">Jogadores do Torneio</h2>
            <div class="text-muted">
                {{ tournament.nome }} 
                {% if tournament.status == "AGENDADO" %}
                    <span class="badge bg-success ms-2">Agendado</span>
                {% elif tournament.status == "EM_ANDAMENTO" %}
                    <span class="badge bg-warning text-dark ms-2">Em Andamento</span>
                {% elif tournament.status == "FINALIZADO" %}
                    <span class="badge bg-danger ms-2">Finalizado</span>
                {% endif %}
            </div>
        </div>
        <div class="d-flex gap-2">
            {% if tournament.status != "AGENDADO" %}
            <a href="{% url 'prize_distribution' tournament.id %}" class="btn btn-primary" title="Configurar distribuição de prêmios">
                <i class="bi bi-trophy-fill"></i> Prêmios
            </a>
            {% endif %}
            <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalMudarStatus" title="Alterar status do torneio">
                <i class="bi bi-pencil-square"></i> Mudar Status
            </button>
            <a href="{% url 'season_tournaments' season.id %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    {% if mensagem %}
        <div class="alert alert-success d-flex align-items-center" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i> {{ mensagem }}
        </div>
    {% endif %}
    {% if mensagem_erro %}
        <div class="alert alert-danger d-flex align-items-center" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> {{ mensagem_erro }}
        </div>
    {% endif %}
    {% if edicao_bloqueada %}
        <div class="alert alert-warning d-flex align-items-center" role="alert">
            <i class="bi bi-lock-fill me-2"></i> Torneio finalizado ou cancelado. Edição bloqueada.
        </div>
    {% endif %}

    <form method="POST">
        {% csrf_token %}

        <div class="row g-4">
            
            <div class="col-lg-8">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i> Lista de Inscritos</h5>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-center" style="width: 50px;">
                                        <i class="bi bi-trash"></i>
                                    </th>
                                    <th>Jogador</th>
                                    <th>Solicitação</th>
                                    <th>Produtos</th>
                                    {% if tournament.permite_rebuy %}<th class="text-center">Rebuy</th>{% endif %}
                                    {% if tournament.permite_rebuy_duplo %}<th class="text-center">Rebuy Duplo</th>{% endif %}
                                    {% if tournament.permite_addon %}<th class="text-center">Add-on</th>{% endif %}
                                    {% if tournament.timechip_chips %}<th class="text-center">Time Chip</th>{% endif %}
                                    <th class="text-center">Confirmado?</th>
                                    <th class="text-center" style="width: 60px;" title="Ver detalhes de compras"><i class="bi bi-receipt"></i></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in entries %}
                                    <tr class="{% if entry.confirmado_pelo_admin %}table-success-subtle{% elif entry.confirmou_presenca %}table-warning-subtle{% endif %}">
                                        <td class="text-center">
                                            <input class="form-check-input border-danger" type="checkbox" name="remover_entry_id" value="{{ entry.id }}" 
                                                   {% if edicao_bloqueada %}disabled{% endif %}>
                                        </td>
                                        <td>
                                            <span class="fw-bold text-dark">{{ entry.player.nome }}</span>
                                            {% if entry.player.apelido %}
                                                <small class="text-muted d-block">({{ entry.player.apelido }})</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if entry.confirmou_presenca %}
                                                <span class="badge text-bg-warning">Pediu vaga</span>
                                            {% else %}
                                                <span class="text-muted small">Inserido pelo Admin</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="products-badge">
                                                {% if entry.product_purchases %}
                                                    {% for product in products %}
                                                        {% if product.id in entry.product_purchases %}
                                                            {% if product.nome not in "REBUY,REBUY_DUPLO,ADDON,STAFF,TIME_CHIP" %}
                                                            <span class="badge bg-success product-badge">
                                                                <i class="bi bi-check-lg"></i> {{ product.nome }}
                                                            </span>
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endif %}
                                            </div>
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-secondary btn-sm"
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#produtosModal"
                                                    data-player-id="{{ entry.player.id }}"
                                                    data-player-name="{{ entry.player.nome }}"
                                                    {% if edicao_bloqueada %}disabled{% endif %}>
                                                <i class="bi bi-gift"></i> <span class="d-none d-sm-inline">Adicionar</span>
                                            </button>
                                        </td>
                                        {% if tournament.permite_rebuy %}
                                        <td class="text-center">
                                            <button type="button" class="btn btn-sm btn-outline-warning rebuy-btn"
                                                    data-tournament-id="{{ tournament.id }}"
                                                    data-player-id="{{ entry.player.id }}"
                                                    data-player-name="{{ entry.player.nome }}"
                                                    data-tipo="REBUY"
                                                    {% if edicao_bloqueada %}disabled{% endif %}>
                                                <i class="bi bi-arrow-clockwise"></i>
                                                {% with rebuy_count=entry.get_rebuy_count %}
                                                <span class="badge bg-danger rebuy-count-{{ entry.player.id }} badge-with-remove{% if not rebuy_count %} d-none{% endif %}" data-player-id="{{ entry.player.id }}" data-tournament-id="{{ tournament.id }}" data-tipo="REBUY" style="cursor: pointer; position: relative; padding-right: 18px;">
                                                    <span class="badge-text">{{ rebuy_count }}</span>
                                                    <span class="badge-remove" style="position: absolute; right: 2px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 12px; font-weight: bold;">✕</span>
                                                </span>
                                                {% endwith %}
                                            </button>
                                        </td>
                                        {% endif %}
                                        {% if tournament.permite_rebuy_duplo %}
                                        <td class="text-center">
                                            <button type="button" class="btn btn-sm btn-outline-warning rebuy-duplo-btn"
                                                    data-tournament-id="{{ tournament.id }}"
                                                    data-player-id="{{ entry.player.id }}"
                                                    data-player-name="{{ entry.player.nome }}"
                                                    data-tipo="REBUY_DUPLO"
                                                    title="Rebuy Duplo (2x ou valor diferenciado)"
                                                    {% if edicao_bloqueada %}disabled{% endif %}>
                                                <i class="bi bi-arrow-clockwise"></i>
                                                <i class="bi bi-arrow-clockwise"></i>
                                                {% with rebuy_duplo_count=entry.get_rebuy_duplo_count %}
                                                <span class="badge bg-dark rebuy-duplo-count-{{ entry.player.id }} badge-with-remove{% if not rebuy_duplo_count %} d-none{% endif %}" data-player-id="{{ entry.player.id }}" data-tournament-id="{{ tournament.id }}" data-tipo="REBUY_DUPLO" style="cursor: pointer; position: relative; padding-right: 18px;">
                                                    <span class="badge-text">{{ rebuy_duplo_count }}</span>
                                                    <span class="badge-remove" style="position: absolute; right: 2px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 12px; font-weight: bold;">✕</span>
                                                </span>
                                                {% endwith %}
                                            </button>
                                        </td>
                                        {% endif %}
                                        {% if tournament.permite_addon %}
                                        <td class="text-center">
                                            <button type="button" class="btn btn-sm btn-outline-info addon-btn"
                                                    data-tournament-id="{{ tournament.id }}"
                                                    data-player-id="{{ entry.player.id }}"
                                                    data-player-name="{{ entry.player.nome }}"
                                                    data-tipo="ADDON"
                                                    {% if edicao_bloqueada %}disabled{% endif %}>
                                                <i class="bi bi-plus-lg"></i>
                                                {% with addon_count=entry.get_addon_count %}
                                                <span class="badge bg-success addon-count-{{ entry.player.id }} badge-with-remove{% if not addon_count %} d-none{% endif %}" data-player-id="{{ entry.player.id }}" data-tournament-id="{{ tournament.id }}" data-tipo="ADDON" style="cursor: pointer; position: relative; padding-right: 18px;">
                                                    <span class="badge-text">{{ addon_count }}</span>
                                                    <span class="badge-remove" style="position: absolute; right: 2px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 12px; font-weight: bold;">✕</span>
                                                </span>
                                                {% endwith %}
                                            </button>
                                        </td>
                                        {% endif %}
                                        {% if tournament.timechip_chips %}
                                        <td class="text-center">
                                            <button type="button" class="btn btn-sm btn-outline-success timechip-btn"
                                                    data-tournament-id="{{ tournament.id }}"
                                                    data-player-id="{{ entry.player.id }}"
                                                    data-player-name="{{ entry.player.nome }}"
                                                    data-tipo="TIME_CHIP"
                                                    title="Time Chip - Jogador chegou a tempo"
                                                    {% if edicao_bloqueada %}disabled{% endif %}>
                                                <i class="bi bi-clock-fill"></i>
                                                {% with timechip_count=entry.get_timechip_count %}
                                                <span class="badge bg-success timechip-count-{{ entry.player.id }} badge-with-remove{% if not timechip_count %} d-none{% endif %}" data-player-id="{{ entry.player.id }}" data-tournament-id="{{ tournament.id }}" data-tipo="TIME_CHIP" style="cursor: pointer; position: relative; padding-right: 18px;">
                                                    <span class="badge-text">{{ timechip_count }}</span>
                                                    <span class="badge-remove" style="position: absolute; right: 2px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 12px; font-weight: bold;">✕</span>
                                                </span>
                                                {% endwith %}
                                            </button>
                                        </td>
                                        {% endif %}
                                        <td class="text-center">
                                            <div class="form-check form-switch d-inline-block">
                                                <input class="form-check-input" type="checkbox" name="conf_admin_{{ entry.id }}" 
                                                       {% if entry.confirmado_pelo_admin %}checked{% endif %}
                                                       {% if edicao_bloqueada %}disabled{% endif %}>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-sm btn-outline-info btn-rebuy-details" 
                                                    title="Ver histórico de rebuys e add-ons"
                                                    data-tournament-id="{{ tournament.id }}"
                                                    data-player-id="{{ entry.player.id }}"
                                                    data-player-name="{{ entry.player.nome }}">
                                                <i class="bi bi-receipt"></i>
                                            </button>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center py-5 text-muted">
                                            Nenhum jogador inscrito neste torneio.
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="card-footer bg-light d-flex justify-content-between p-3 flex-wrap gap-2">
                        <button type="submit" name="remove_selected" class="btn btn-outline-danger btn-sm"
                                onclick="return confirm('Remover os jogadores selecionados?');"
                                {% if edicao_bloqueada %}disabled{% endif %}>
                            <i class="bi bi-trash"></i> Remover Selecionados
                        </button>

                        <div class="d-flex gap-2">
                            <button type="submit" name="confirm_all_requests" class="btn btn-warning btn-sm fw-bold text-dark"
                                    {% if edicao_bloqueada %}disabled{% endif %}>
                                <i class="bi bi-check-all"></i> Confirmar Pedidos
                            </button>
                            <button type="submit" name="save_admin_confirm" class="btn btn-primary btn-sm fw-bold"
                                    {% if edicao_bloqueada %}disabled{% endif %}>
                                <i class="bi bi-save"></i> Salvar Alterações
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm border-0 sticky-top" style="top: 20px;">
                    <div class="card-header bg-success text-white py-3">
                        <h5 class="mb-0"><i class="bi bi-person-plus-fill me-2"></i> Adicionar Manualmente</h5>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted mb-3">Insira um jogador diretamente no torneio (sem que ele precise pedir).</p>
                        
                        <div class="mb-3">
                            <label for="novo_player_id" class="form-label fw-bold">Selecione o Jogador</label>
                            <select class="form-select" name="novo_player_id" id="novo_player_id" {% if entrada_bloqueada %}disabled{% endif %}>
                                <option value="">Buscar jogador...</option>
                                {% for p in players_disponiveis %}
                                    <option value="{{ p.id }}">{{ p.nome }} {% if p.apelido %}({{ p.apelido }}){% endif %}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" name="add_player" class="btn btn-success fw-bold"
                                    {% if entrada_bloqueada %}disabled{% endif %}>
                                <i class="bi bi-plus-lg"></i> Adicionar
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#modalNovoJogador"
                                    {% if edicao_bloqueada %}disabled{% endif %}>
                                <i class="bi bi-person-check"></i> Criar Novo Jogador
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </form>
</div>

<!-- Modal para Adicionar Produtos -->
<div class="modal fade" id="produtosModal" tabindex="-1" aria-labelledby="produtosModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="produtosModalLabel">
                    <i class="bi bi-gift"></i> Adicionar Produtos - <span id="playerNameModal"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Selecione os produtos que este jogador adquiriu
                </div>
                <form id="productForm" method="POST" action="{% url 'tournament_entries_manage' tournament.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="add_products" value="1">
                    <input type="hidden" id="playerId" name="player_id" value="">
                    
                    <div class="row g-3">
                        {% for product in products %}
                        <div class="col-md-6">
                            <div class="form-check">
                                <input 
                                    class="form-check-input product-checkbox" 
                                    type="checkbox" 
                                    name="products" 
                                    value="{{ product.id }}" 
                                    id="product_{{ product.id }}"
                                    data-product-name="{{ product.nome }}"
                                    data-product-price="{{ product.valor }}">
                                <label class="form-check-label w-100" for="product_{{ product.id }}">
                                    <div class="fw-bold">{{ product.nome }}</div>
                                    <small class="text-muted">R$ {{ product.valor|floatformat:2 }}</small>
                                    {% if product.descricao %}
                                        <div class="small text-muted">{{ product.descricao }}</div>
                                    {% endif %}
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="mt-4 p-3 bg-light rounded">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Total de Produtos:</h6>
                            <span class="badge bg-primary fs-6" id="totalProducts">R$ 0,00</span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" form="productForm" class="btn btn-success">
                    <i class="bi bi-plus-lg"></i> Adicionar Produtos
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('produtosModal');
    const playerId = document.getElementById('playerId');
    const playerNameModal = document.getElementById('playerNameModal');
    const productCheckboxes = document.querySelectorAll('.product-checkbox');
    const totalProducts = document.getElementById('totalProducts');

    // Atualizar total quando checkbox é clicado
    productCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateTotal();
        });
    });

    function updateTotal() {
        let total = 0;
        productCheckboxes.forEach(checkbox => {
            if (checkbox.checked) {
                total += parseFloat(checkbox.dataset.productPrice) || 0;
            }
        });
        totalProducts.textContent = 'R$ ' + total.toFixed(2).replace('.', ',');
    }

    // Quando o modal é aberto
    modal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const id = button.dataset.playerId;
        const name = button.dataset.playerName;
        
        playerId.value = id;
        playerNameModal.textContent = name;

        // Desmarcar todos os checkboxes
        productCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        
        updateTotal();
    });
});
</script>

<!-- MODAL: Criar Novo Jogador -->
<div class="modal fade" id="modalNovoJogador" tabindex="-1" aria-labelledby="modalNovoJogadorLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="modalNovoJogadorLabel">
                    <i class="bi bi-person-plus-fill"></i> Novo Jogador
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formNovoJogador">
                {% csrf_token %}
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label for="inputNomeJogador" class="form-label">Nome Completo</label>
                        <input type="text" class="form-control" id="inputNomeJogador" name="nome" 
                               placeholder="Ex: João da Silva" required>
                    </div>

                    <div class="mb-3">
                        <label for="inputApelidoJogador" class="form-label">Apelido (Como será chamado)</label>
                        <input type="text" class="form-control" id="inputApelidoJogador" name="apelido" 
                               placeholder="Ex: João">
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="inputCpfJogador" class="form-label">CPF</label>
                            <input type="text" class="form-control" id="inputCpfJogador" name="cpf" 
                                   placeholder="000.000.000-00">
                        </div>
                        <div class="col-md-6">
                            <label for="inputTelefoneJogador" class="form-label">Telefone / WhatsApp</label>
                            <input type="tel" class="form-control" id="inputTelefoneJogador" name="telefone" 
                                   placeholder="(00) 00000-0000">
                        </div>
                    </div>

                    <div class="mb-4 pt-2 border-top">
                        <div class="form-check form-switch mt-3">
                            <input class="form-check-input" type="checkbox" id="inputCriarUsuario" name="criar_usuario">
                            <label class="form-check-label fw-bold" for="inputCriarUsuario">
                                Criar usuário de acesso?
                            </label>
                            <div class="form-text">Deixe desmarcado se for apenas um jogador de passagem.</div>
                        </div>
                    </div>

                    <div id="camposUsuario" style="display: none;">
                        <div class="mb-3">
                            <label for="inputUsernameJogador" class="form-label">
                                Username
                            </label>
                            <input type="text" class="form-control" id="inputUsernameJogador" name="username" 
                                   placeholder="Ex: joao_silva">
                            <small class="form-text text-muted">Identificador único para login (sem espaços)</small>
                        </div>

                        <div class="mb-3">
                            <label for="inputEmailJogador" class="form-label">
                                Email
                            </label>
                            <input type="email" class="form-control" id="inputEmailJogador" name="email" 
                                   placeholder="Ex: joao@email.com">
                            <small class="form-text text-muted">Para login e notificações</small>
                        </div>
                    </div>

                    <div id="alertErroJogador" class="alert alert-danger d-none" role="alert"></div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-arrow-left"></i> Voltar
                    </button>
                    <button type="submit" class="btn btn-primary px-5 fw-bold rounded-pill" id="btnCriarJogador">
                        SALVAR
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// ============================================================
// MODAL: Criar Novo Jogador
// ============================================================
document.addEventListener('DOMContentLoaded', function() {
    const formNovoJogador = document.getElementById('formNovoJogador');
    if (!formNovoJogador) {
        console.log('Form não encontrado - pulando inicialização');
        return;
    }

    const toggleCriarUsuario = document.getElementById('inputCriarUsuario');
    const camposUsuario = document.getElementById('camposUsuario');

    // Mostrar/esconder campos de usuário quando checkbox muda
    if (toggleCriarUsuario && camposUsuario) {
        toggleCriarUsuario.addEventListener('change', function() {
            if (this.checked) {
                camposUsuario.style.display = 'block';
                const usernameField = document.getElementById('inputUsernameJogador');
                if (usernameField) usernameField.focus();
            } else {
                camposUsuario.style.display = 'none';
                const usernameField = document.getElementById('inputUsernameJogador');
                const emailField = document.getElementById('inputEmailJogador');
                if (usernameField) usernameField.value = '';
                if (emailField) emailField.value = '';
            }
        });
    }
    
    formNovoJogador.addEventListener('submit', async function(e) {
        e.preventDefault();
    
    const nome = document.getElementById('inputNomeJogador').value.trim();
    const apelido = document.getElementById('inputApelidoJogador').value.trim();
    const cpf = document.getElementById('inputCpfJogador').value.trim();
    const telefone = document.getElementById('inputTelefoneJogador').value.trim();
    const criarUsuario = document.getElementById('inputCriarUsuario').checked;
    const username = document.getElementById('inputUsernameJogador').value.trim();
    const email = document.getElementById('inputEmailJogador').value.trim();
    const alertError = document.getElementById('alertErroJogador');
    const btnCriar = document.getElementById('btnCriarJogador');
    
    // Limpar alerta
    alertError.classList.add('d-none');
    alertError.innerHTML = '';
    
    // Validação básica - apenas Nome é obrigatório
    if (!nome) {
        alertError.innerHTML = '<i class="bi bi-exclamation-circle"></i> Por favor, preencha o nome do jogador.';
        alertError.classList.remove('d-none');
        return;
    }

    // Se vai criar usuário, validar os campos
    if (criarUsuario) {
        if (!username || !email) {
            alertError.innerHTML = '<i class="bi bi-exclamation-circle"></i> Para criar usuário, preencha username e email.';
            alertError.classList.remove('d-none');
            return;
        }

        if (username.includes(' ')) {
            alertError.innerHTML = '<i class="bi bi-exclamation-circle"></i> Username não pode conter espaços.';
            alertError.classList.remove('d-none');
            return;
        }
    }

    btnCriar.disabled = true;
    btnCriar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>SALVANDO...';

    try {
        const response = await fetch('{% url "player_create_quick" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                nome: nome,
                apelido: apelido || null,
                cpf: cpf || null,
                telefone: telefone || null,
                username: criarUsuario ? username : null,
                email: criarUsuario ? email : null
            })
        });

        const data = await response.json();

        if (response.ok && data.success) {
            // Adicionar novo jogador ao select
            const select = document.getElementById('novo_player_id');
            const option = document.createElement('option');
            option.value = data.player_id;
            option.textContent = data.player_nome + (data.player_apelido ? ' (' + data.player_apelido + ')' : '');
            select.appendChild(option);
            
            // Selecionar o novo jogador
            select.value = data.player_id;
            
            // Fechar modal
            const modalElement = document.getElementById('modalNovoJogador');
            if (modalElement) {
                let modal = bootstrap.Modal.getInstance(modalElement);
                if (!modal) {
                    modal = new bootstrap.Modal(modalElement);
                }
                modal.hide();
            }
            
            // Resetar formulário
            document.getElementById('formNovoJogador').reset();
            toggleCriarUsuario.checked = false;
            camposUsuario.style.display = 'none';
            
            // Mostrar mensagem de sucesso
            const successAlert = document.createElement('div');
            successAlert.className = 'alert alert-success alert-dismissible fade show';
            const userInfo = data.tem_usuario ? ' (com acesso de login)' : ' (jogador de passagem)';
            successAlert.innerHTML = `
                <i class="bi bi-check-circle-fill"></i> Jogador <strong>${data.player_nome}</strong> criado com sucesso${userInfo}! 
                Clique em "Adicionar" para adicioná-lo ao torneio.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(successAlert, document.querySelector('script'));
            
            // Auto-remover após 5 segundos
            setTimeout(() => successAlert.remove(), 5000);
        } else {
            alertError.innerHTML = `<i class="bi bi-exclamation-circle"></i> ${data.error || 'Erro ao criar jogador.'}`;
            alertError.classList.remove('d-none');
        }
    } catch (error) {
        alertError.innerHTML = '<i class="bi bi-exclamation-circle"></i> Erro ao criar jogador. Tente novamente.';
        alertError.classList.remove('d-none');
        console.error('Erro:', error);
    } finally {
        btnCriar.disabled = false;
        btnCriar.innerHTML = 'SALVAR';
    }
    }); // Fecha addEventListener do form
}); // Fecha DOMContentLoaded

// ============================================================
// REBUY E ADD-ON BUTTONS - COM DELEGAÇÃO DE EVENTO
// ============================================================
document.addEventListener('DOMContentLoaded', function() {
    // Procurar todos os botões
    const rebuBtns = document.querySelectorAll('button.rebuy-btn');
    const rebuyDuploBtns = document.querySelectorAll('button.rebuy-duplo-btn');
    const addonBtns = document.querySelectorAll('button.addon-btn');
    const timeChipBtns = document.querySelectorAll('button.timechip-btn');
    
    // Adicionar listeners a cada botão
    [...rebuBtns, ...rebuyDuploBtns, ...addonBtns, ...timeChipBtns].forEach((btn) => {
        btn.addEventListener('click', handleRebuyAddonClick);
    });
    
    // Adicionar listeners aos badges com X (remover)
    document.querySelectorAll('.badge-with-remove').forEach((badge) => {
        badge.addEventListener('click', handleRemoveBadgeClick);
    });
});

async function handleRemoveBadgeClick(e) {
    e.preventDefault();
    e.stopPropagation();
    
    // Abrir modal de confirmação ao invés de remover direto
    const badge = this;
    
    // Adicionar dados do jogador ao badge para usar no modal
    // Tentar obter do botão pai
    const button = badge.closest('button');
    if (button) {
        badge.dataset.playerName = button.dataset.playerName || 'Jogador';
    }
    
    showRemovalConfirmationModal.call(badge, e);
}

async function handleRebuyAddonClick(e) {
    // Abrir modal de confirmação ao invés de fazer direto
    showRebuyConfirmationModal.call(this, e);
}

function showNotification(message, type) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.style.margin = '10px';
    alert.innerHTML = `
        <i class="bi bi-${type === 'success' ? 'check-circle-fill' : 'exclamation-circle'}"></i> 
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Adicionar ao body - simples e seguro
    document.body.appendChild(alert);
    
    // Auto-remover após 4 segundos
    setTimeout(() => {
        try {
            alert.remove();
        } catch (e) {
        }
    }, 4000);
}

// ============================================================
// MODAL DE DETALHES: Histórico de Rebuys
// ============================================================
function openRebuyDetailsModal(tournamentId, playerId, playerName) {
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('modalRebuyDetails'));
    modal.show();
    
    // Carregar dados
    loadRebuyHistory(tournamentId, playerId, playerName);
}

async function loadRebuyHistory(tournamentId, playerId, playerName) {
    const contentDiv = document.getElementById('rebuyDetailsContent');
    contentDiv.innerHTML = '<div class="text-center"><span class="spinner-border spinner-border-sm"></span> Carregando...</div>';
    
    try {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const response = await fetch(`/api/torneio/${tournamentId}/jogador/${playerId}/rebuy-history/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrfToken
            }
        });
        
        if (!response.ok) {
            contentDiv.innerHTML = `
                <div class="alert alert-danger mb-0">
                    <i class="bi bi-exclamation-circle"></i> Erro ao carregar (Status ${response.status})
                </div>
            `;
            return;
        }
        
        const result = await response.json();
        
        if (!result.success) {
            contentDiv.innerHTML = `
                <div class="alert alert-danger mb-0">
                    <i class="bi bi-exclamation-circle"></i> ${result.error || 'Erro desconhecido'}
                </div>
            `;
            return;
        }
        
        if (!result.data || !result.data.compras || result.data.compras.length === 0) {
            contentDiv.innerHTML = `
                <div class="alert alert-info mb-0">
                    <i class="bi bi-info-circle"></i> Nenhuma compra de rebuy/addon registrada para este jogador.
                </div>
            `;
            return;
        }
        
        // Escapar HTML
        const escapeHtml = (text) => {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };
        
        let html = '<div class="card">';
        html += '<div class="card-header bg-light">';
        html += '<h6 class="mb-0"><i class="bi bi-person"></i> ' + escapeHtml(result.data.jogador) + '</h6>';
        html += '<small class="text-muted">' + escapeHtml(result.data.torneio) + '</small>';
        html += '</div>';
        html += '<div class="card-body p-0">';
        html += '<div class="table-responsive" style="font-size: 0.85rem;">';
        html += '<table class="table table-sm mb-0">';
        html += '<thead class="table-light"><tr>';
        html += '<th>Tipo</th>';
        html += '<th class="text-end">Valor Unit.</th>';
        html += '<th class="text-end">Total</th>';
        html += '<th>Horário</th>';
        html += '<th>Lançado por</th>';
        html += '<th>Observação</th>';
        html += '</tr></thead>';
        html += '<tbody>';
        
        // Desagrupar compras: se quantidade > 1, mostrar como múltiplas linhas
        result.data.compras.forEach(compra => {
            // Criar uma linha para cada unidade comprada
            for (let i = 0; i < compra.quantidade; i++) {
                html += '<tr>';
                html += '<td><span class="badge bg-primary">' + escapeHtml(compra.tipo_display) + '</span></td>';
                html += '<td class="text-end">R$ ' + parseFloat(compra.valor_unitario).toFixed(2) + '</td>';
                html += '<td class="text-end"><strong>R$ ' + parseFloat(compra.valor_unitario).toFixed(2) + '</strong></td>';
                html += '<td><small>' + escapeHtml(compra.data_lancamento) + '</small></td>';
                html += '<td><small>' + escapeHtml(compra.lancado_por) + '</small></td>';
                html += '<td><small class="text-muted">' + escapeHtml(compra.observacao) + '</small></td>';
                html += '</tr>';
            }
        });
        
        html += '</tbody></table></div></div>';
        html += '<div class="card-footer bg-light">';
        html += '<div class="row text-center">';
        html += '<div class="col-md-6"><strong>Total de Compras:</strong> ' + result.data.total_quantidade + 'x</div>';
        html += '<div class="col-md-6"><strong>Valor Total:</strong> R$ ' + parseFloat(result.data.total_valor).toFixed(2) + '</div>';
        html += '</div></div></div>';
        
        contentDiv.innerHTML = html;
        
    } catch (error) {
        contentDiv.innerHTML = `
            <div class="alert alert-danger mb-0">
                <i class="bi bi-exclamation-circle"></i> Erro: ${escapeHtml(error.message)}
            </div>
        `;
        console.error('Erro ao carregar histórico de rebuys:', error);
    }
}
</script>

<script>
// Adicionar listeners aos botões de "Ver Detalhes"
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.btn-rebuy-details').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const tournamentId = this.dataset.tournamentId;
            const playerId = this.dataset.playerId;
            const playerName = this.dataset.playerName;
            openRebuyDetailsModal(tournamentId, playerId, playerName);
        });
    });
});
</script>

<!-- Modal: Detalhes de Rebuys, Add-ons e Compras -->
<div class="modal fade" id="modalRebuyDetails" tabindex="-1" aria-labelledby="modalRebuyDetailsLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="margin-top: 80px;">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="modalRebuyDetailsLabel">
                    <i class="bi bi-receipt"></i> Histórico de Rebuys, Add-ons e Compras
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div id="rebuyDetailsContent">
                    <!-- Conteúdo dinâmico será carregado aqui -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Mudar Status do Torneio -->
<div class="modal fade" id="modalMudarStatus" tabindex="-1" aria-labelledby="modalMudarStatusLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="modalMudarStatusLabel">
                    <i class="bi bi-pencil-square me-2"></i> Alterar Status do Torneio
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form id="formMudarStatus" method="POST" action="{% url 'tournament_update_status' tournament.id %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="selectStatus" class="form-label">Selecione o novo status:</label>
                        <select class="form-select form-select-lg" id="selectStatus" name="status" required>
                            <option value="">-- Escolha uma opção --</option>
                            {% if tournament.status != "EM_ANDAMENTO" %}
                            <option value="EM_ANDAMENTO">
                                <i class="bi bi-play-circle"></i> Iniciar Torneio
                            </option>
                            {% endif %}
                            {% if tournament.status != "FINALIZADO" %}
                            <option value="FINALIZADO">
                                <i class="bi bi-stop-circle"></i> Finalizar Torneio
                            </option>
                            {% endif %}
                            {% if tournament.status != "CANCELADO" %}
                            <option value="CANCELADO">
                                <i class="bi bi-x-circle"></i> Cancelar Torneio
                            </option>
                            {% endif %}
                        </select>
                        <small class="form-text text-muted d-block mt-2">
                            <i class="bi bi-info-circle"></i> 
                            Status atual: <strong>{{ tournament.get_status_display }}</strong>
                        </small>
                    </div>
                    <div class="alert alert-info" role="alert">
                        <i class="bi bi-lightbulb me-2"></i>
                        <strong>Nota:</strong> Mudanças de status afetarão a disponibilidade de funcionalidades do torneio.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="btnConfirmarMudarStatus">
                    <i class="bi bi-check-lg me-1"></i> Confirmar Mudança
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Confirmar mudança de status com AJAX
document.getElementById('btnConfirmarMudarStatus').addEventListener('click', async function() {
    const selectStatus = document.getElementById('selectStatus');
    const novoStatus = selectStatus.value;
    
    if (!novoStatus) {
        alert('Por favor, selecione um status.');
        return;
    }
    
    const form = document.getElementById('formMudarStatus');
    const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;
    
    try {
        const response = await fetch(form.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ status: novoStatus })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Status alterado com sucesso!', 'success');
            // Atualizar a página após 1 segundo
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showNotification(data.error || 'Erro ao alterar status.', 'danger');
        }
    } catch (error) {
        showNotification('Erro: ' + error.message, 'danger');
    }
});
</script>

<!-- MODAL DE CONFIRMAÇÃO PARA REBUYS -->
<div class="modal fade" id="rebuyConfirmationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-light border-bottom">
                <h5 class="modal-title" id="rebuyModalTitle">Confirmar Lançamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <!-- Informações do Rebuy -->
                <div class="alert alert-info mb-3" role="alert">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-info-circle me-2 mt-1"></i>
                        <div>
                            <strong id="rebuyInfo"></strong>
                            <p id="rebuyDetails" class="mb-0 small text-muted mt-1"></p>
                        </div>
                    </div>
                </div>

                <!-- Campos de Confirmação -->
                <div class="mb-3">
                    <label for="rebuyObservacao" class="form-label">
                        <i class="bi bi-chat-left-text"></i> Observação (opcional)
                    </label>
                    <textarea 
                        class="form-control" 
                        id="rebuyObservacao" 
                        rows="3" 
                        placeholder="Ex: Rebuy confirmado em mesa, jogador estava fora, etc."
                        style="font-size: 0.95rem;">
                    </textarea>
                    <small class="form-text text-muted">Deixe uma nota sobre este lançamento para referência futura</small>
                </div>

                <!-- Resumo Visual -->
                <div class="card bg-light border-0">
                    <div class="card-body p-3">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted d-block">Jogador</small>
                                <strong id="rebuyPlayerName">-</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Tipo</small>
                                <strong id="rebuyType">-</strong>
                            </div>
                        </div>
                        <hr class="my-2">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted d-block">Valor</small>
                                <strong id="rebuyValue">R$ 0,00</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Quantidade Atual</small>
                                <strong id="rebuyCurrentQty">0</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-top">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmRebuyBtn">
                    <i class="bi bi-check-circle"></i> Confirmar Lançamento
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// ===== MODAL DE REBUY =====
let rebuyPendingData = null;

async function showRebuyConfirmationModal(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const btn = this;
    const tournamentId = btn.dataset.tournamentId;
    const playerId = btn.dataset.playerId;
    const playerName = btn.dataset.playerName;
    const tipo = btn.dataset.tipo;
    
    // Obter dados do torneio e do jogador
    const tipoLabel = {
        'REBUY': 'Rebuy Simples',
        'REBUY_DUPLO': 'Rebuy Duplo',
        'ADDON': 'Add-on',
        'TIME_CHIP': 'Time Chip'
    }[tipo] || tipo;
    
    // Buscar informações do rebuy
    const tournament = window.tournamentData || {};
    let valor = 'R$ 0,00';
    let detalhes = '';
    
    if (tipo === 'REBUY' && tournament.rebuy_valor) {
        valor = `R$ ${parseFloat(tournament.rebuy_valor).toFixed(2).replace('.', ',')}`;
        detalhes = `Rebuy simples do torneio`;
    } else if (tipo === 'REBUY_DUPLO' && tournament.rebuy_duplo_valor) {
        valor = `R$ ${parseFloat(tournament.rebuy_duplo_valor).toFixed(2).replace('.', ',')}`;
        detalhes = `Rebuy duplo (2x ou valor diferenciado)`;
    } else if (tipo === 'ADDON' && tournament.addon_valor) {
        valor = `R$ ${parseFloat(tournament.addon_valor).toFixed(2).replace('.', ',')}`;
        detalhes = `Add-on (máximo 1 por jogador)`;
    } else if (tipo === 'TIME_CHIP') {
        valor = 'Sem valor';
        detalhes = `Time Chip (máximo 1 por jogador)`;
    }
    
    // Obter quantidade atual
    let currentQty = 0;
    const counterClass = {
        'REBUY': `rebuy-count-${playerId}`,
        'REBUY_DUPLO': `rebuy-duplo-count-${playerId}`,
        'ADDON': `addon-count-${playerId}`,
        'TIME_CHIP': `timechip-count-${playerId}`
    }[tipo];
    
    const badge = document.querySelector(`.${counterClass} .badge-text`);
    if (badge) {
        currentQty = parseInt(badge.textContent) || 0;
    }
    
    // Preencher modal
    document.getElementById('rebuyModalTitle').textContent = `Confirmar ${tipoLabel}`;
    document.getElementById('rebuyInfo').textContent = `${tipoLabel} para ${playerName}`;
    document.getElementById('rebuyDetails').textContent = detalhes;
    document.getElementById('rebuyPlayerName').textContent = playerName;
    document.getElementById('rebuyType').textContent = tipoLabel;
    document.getElementById('rebuyValue').textContent = valor;
    document.getElementById('rebuyCurrentQty').textContent = currentQty;
    document.getElementById('rebuyObservacao').value = '';
    
    // Salvar dados pendentes
    rebuyPendingData = {
        tournamentId,
        playerId,
        playerName,
        tipo
    };
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('rebuyConfirmationModal'));
    modal.show();
}

// Confirmar rebuy
document.addEventListener('DOMContentLoaded', function() {
    const confirmBtn = document.getElementById('confirmRebuyBtn');
    if (confirmBtn) {
        confirmBtn.addEventListener('click', async function() {
            if (!rebuyPendingData) return;
            
            const observacao = document.getElementById('rebuyObservacao').value.trim();
            const { tournamentId, playerId, tipo } = rebuyPendingData;
    
    // Desabilitar botão
    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processando...';
    
    try {
        const endpoint = `/api/torneio/${tournamentId}/rebuy-addon/`;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        const payload = {
            player_id: parseInt(playerId),
            tipo: tipo,
            observacao: observacao
        };
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Fechar modal
            bootstrap.Modal.getInstance(document.getElementById('rebuyConfirmationModal')).hide();
            
            // Atualizar badge
            const counterClass = {
                'REBUY': `rebuy-count-${playerId}`,
                'REBUY_DUPLO': `rebuy-duplo-count-${playerId}`,
                'ADDON': `addon-count-${playerId}`,
                'TIME_CHIP': `timechip-count-${playerId}`
            }[tipo];
            
            let counter = document.querySelector(`.${counterClass}`);
            
            if (counter) {
                counter.classList.remove('d-none');
                counter.style.display = 'inline-block';
                
                const badgeText = counter.querySelector('.badge-text');
                if (badgeText) {
                    badgeText.textContent = data.quantidade;
                }
            }
            
            showNotification(data.message, 'success');
        } else {
            showNotification(data.error || 'Erro ao processar', 'danger');
        }
    } catch (error) {
        showNotification('Erro: ' + error.message, 'danger');
    } finally {
        // Reabilitar botão
        this.disabled = false;
        this.innerHTML = '<i class="bi bi-check-circle"></i> Confirmar Lançamento';
            }
        });
    }
});

// ===== MODAL DE REMOÇÃO DE REBUY =====
let removalPendingData = null;

async function showRemovalConfirmationModal(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const badge = this;
    const tournamentId = badge.dataset.tournamentId;
    const playerId = badge.dataset.playerId;
    const playerName = badge.dataset.playerName;
    const tipo = badge.dataset.tipo;
    
    // Obter dados
    const tipoLabel = {
        'REBUY': 'Rebuy Simples',
        'REBUY_DUPLO': 'Rebuy Duplo',
        'ADDON': 'Add-on',
        'TIME_CHIP': 'Time Chip'
    }[tipo] || tipo;
    
    // Obter quantidade atual
    const badgeText = badge.querySelector('.badge-text');
    const currentQty = badgeText ? parseInt(badgeText.textContent) : 0;
    
    // Obter valor do rebuy
    const tournament = window.tournamentData || {};
    let valor = 'R$ 0,00';
    let detalhes = '';
    
    if (tipo === 'REBUY' && tournament.rebuy_valor) {
        valor = `R$ ${parseFloat(tournament.rebuy_valor).toFixed(2).replace('.', ',')}`;
        detalhes = `Será removido 1 rebuy de ${currentQty} atual(is)`;
    } else if (tipo === 'REBUY_DUPLO' && tournament.rebuy_duplo_valor) {
        valor = `R$ ${parseFloat(tournament.rebuy_duplo_valor).toFixed(2).replace('.', ',')}`;
        detalhes = `Será removido 1 rebuy duplo de ${currentQty} atual(is)`;
    } else if (tipo === 'ADDON') {
        valor = `R$ ${parseFloat(tournament.addon_valor).toFixed(2).replace('.', ',')}`;
        detalhes = `Será removido o add-on do jogador`;
    } else if (tipo === 'TIME_CHIP') {
        valor = 'Sem valor';
        detalhes = `Será removido o time chip do jogador`;
    }
    
    // Preencher modal
    document.getElementById('removalModalTitle').textContent = `Remover ${tipoLabel}`;
    document.getElementById('removalInfo').textContent = `Remover ${tipoLabel} de ${playerName}`;
    document.getElementById('removalDetails').textContent = detalhes;
    document.getElementById('removalPlayerName').textContent = playerName;
    document.getElementById('removalType').textContent = tipoLabel;
    document.getElementById('removalValue').textContent = valor;
    document.getElementById('removalCurrentQty').textContent = currentQty;
    document.getElementById('removalObservacao').value = '';
    
    // Salvar dados pendentes
    removalPendingData = {
        tournamentId,
        playerId,
        playerName,
        tipo,
        badge
    };
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('removalConfirmationModal'));
    modal.show();
}

// Confirmar remoção
document.addEventListener('DOMContentLoaded', function() {
    const confirmBtn = document.getElementById('confirmRemovalBtn');
    if (confirmBtn) {
        confirmBtn.addEventListener('click', async function() {
            if (!removalPendingData) {
                showNotification('Dados incompletos', 'danger');
                return;
            }
            
            const observacao = document.getElementById('removalObservacao').value.trim();
            
            // Validar se observação foi preenchida
            if (!observacao) {
                showNotification('⚠️ Preencha o motivo da remoção', 'warning');
                document.getElementById('removalObservacao').focus();
                return;
            }
            
            const { tournamentId, playerId, tipo } = removalPendingData;
            
            // Desabilitar botão
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processando...';
            
            try {
                const endpoint = `/api/torneio/${tournamentId}/rebuy-addon/remove/`;
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                const payload = {
                    player_id: parseInt(playerId),
                    tipo: tipo,
                    observacao: observacao
                };
                
                console.log('Enviando payload:', payload);
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(payload)
                });
                
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    // Fechar modal
                    const modalElement = document.getElementById('removalConfirmationModal');
                    const modalInstance = bootstrap.Modal.getInstance(modalElement);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                    
                    // Atualizar badge usando o seletor CSS correto
                    const counterClass = {
                        'REBUY': `rebuy-count-${removalPendingData.playerId}`,
                        'REBUY_DUPLO': `rebuy-duplo-count-${removalPendingData.playerId}`,
                        'ADDON': `addon-count-${removalPendingData.playerId}`,
                        'TIME_CHIP': `timechip-count-${removalPendingData.playerId}`
                    }[removalPendingData.tipo];
                    
                    console.log('Procurando por classe:', counterClass);
                    let counter = document.querySelector(`.${counterClass}`);
                    console.log('Counter encontrado:', counter);
                    
                    if (counter) {
                        const badgeText = counter.querySelector('.badge-text');
                        
                        if (data.quantidade > 0) {
                            if (badgeText) {
                                badgeText.textContent = data.quantidade;
                            } else {
                                counter.textContent = data.quantidade;
                            }
                            counter.style.display = 'inline-block';
                        } else {
                            counter.style.display = 'none';
                        }
                    }
                    
                    showNotification(data.message, 'success');
                } else {
                    showNotification(data.error || 'Erro ao remover', 'danger');
                }
            } catch (error) {
                console.error('Erro:', error);
                showNotification('Erro: ' + error.message, 'danger');
            } finally {
                // Reabilitar botão
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-trash3"></i> Confirmar Remoção';
            }
        });
    }
});
</script>

<!-- MODAL DE CONFIRMAÇÃO PARA REMOVER REBUYS -->
<div class="modal fade" id="removalConfirmationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-danger">
            <div class="modal-header bg-danger bg-opacity-10 border-danger">
                <h5 class="modal-title text-danger" id="removalModalTitle">Confirmar Remoção</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <!-- Informações da Remoção -->
                <div class="alert alert-warning mb-3" role="alert">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-exclamation-triangle me-2 mt-1"></i>
                        <div>
                            <strong id="removalInfo"></strong>
                            <p id="removalDetails" class="mb-0 small text-muted mt-1"></p>
                        </div>
                    </div>
                </div>

                <!-- Motivo da Remoção -->
                <div class="mb-3">
                    <label for="removalObservacao" class="form-label">
                        <i class="bi bi-chat-left-text"></i> Motivo da Remoção (obrigatório)
                    </label>
                    <textarea 
                        class="form-control" 
                        id="removalObservacao" 
                        rows="3" 
                        placeholder="Ex: Erro de lançamento, cancelamento solicitado, duplicado, etc."
                        style="font-size: 0.95rem;"
                        required>
                    </textarea>
                    <small class="form-text text-muted">Justifique a remoção para auditoria</small>
                </div>

                <!-- Resumo Visual -->
                <div class="card bg-light border-0">
                    <div class="card-body p-3">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted d-block">Jogador</small>
                                <strong id="removalPlayerName">-</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Tipo</small>
                                <strong id="removalType">-</strong>
                            </div>
                        </div>
                        <hr class="my-2">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted d-block">Valor</small>
                                <strong id="removalValue">R$ 0,00</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Quantidade Atual</small>
                                <strong id="removalCurrentQty">0</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-top">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmRemovalBtn">
                    <i class="bi bi-trash3"></i> Confirmar Remoção
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}