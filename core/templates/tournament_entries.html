{% extends 'base.html' %}

{% block title %}Inscrições - {{ tournament.nome }}{% endblock %}

{% block extra_css %}
<style>
    .table-responsive {
        overflow: visible !important;
    }
    .products-badge {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
        padding: 4px 0;
    }
    .product-badge {
        font-size: 0.75rem;
        padding: 2px 6px;
    }
    
    /* Esconder tags de produtos que são REBUY, ADDON, STAFF, REBUY_DUPLO */
    .product-badge:has-text("REBUY"),
    .product-badge:has-text("ADDON"),
    .product-badge:has-text("STAFF"),
    .product-badge:contains("REBUY"),
    .product-badge:contains("ADDON"),
    .product-badge:contains("STAFF") {
        display: none !important;
    }
    
    .products-popover {
        max-width: 300px;
    }
    
    /* Modais com z-index altíssimo */
    #modalNovoJogador {
        z-index: 9999 !important;
        pointer-events: auto !important;
    }
    #modalNovoJogador.modal {
        pointer-events: auto !important;
    }
    #modalNovoJogador .modal-dialog {
        pointer-events: auto !important;
        z-index: 9999 !important;
        max-height: calc(100vh - 40px) !important;
        margin-top: 50px !important;
    }
    #modalNovoJogador .modal-content {
        pointer-events: auto !important;
        z-index: 9999 !important;
        max-height: calc(100vh - 40px) !important;
    }
    
    /* Modal body scrollável */
    #modalNovoJogador .modal-body {
        max-height: calc(100vh - 200px) !important;
        overflow-y: auto !important;
        pointer-events: auto !important;
    }
    
    /* Remover backdrop que bloqueia */
    .modal-backdrop {
        display: none !important;
    }
    
    /* Garantir todos os elementos dentro do modal */
    #modalNovoJogador * {
        pointer-events: auto !important;
    }
    
    #modalNovoJogador input,
    #modalNovoJogador textarea,
    #modalNovoJogador select,
    #modalNovoJogador button,
    #modalNovoJogador label,
    #modalNovoJogador .form-control,
    #modalNovoJogador .form-check-input {
        pointer-events: auto !important;
        user-select: text !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <div class="d-flex justify-content-between align-items-center mb-4 mt-2">
        <div>
            <h2 class="mb-1">Jogadores do Torneio</h2>
            <div class="text-muted">
                {{ tournament.nome }} 
                {% if tournament.status == "AGENDADO" %}
                    <span class="badge bg-success ms-2">Agendado</span>
                {% elif tournament.status == "EM_ANDAMENTO" %}
                    <span class="badge bg-warning text-dark ms-2">Em Andamento</span>
                {% elif tournament.status == "FINALIZADO" %}
                    <span class="badge bg-danger ms-2">Finalizado</span>
                {% endif %}
            </div>
        </div>
        <div class="d-flex gap-2">
            {% if tournament.status != "AGENDADO" %}
            <a href="{% url 'prize_distribution' tournament.id %}" class="btn btn-primary" title="Configurar distribuição de prêmios">
                <i class="bi bi-trophy-fill"></i> Prêmios
            </a>
            {% endif %}
            <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalMudarStatus" title="Alterar status do torneio">
                <i class="bi bi-pencil-square"></i> Mudar Status
            </button>
            <a href="{% url 'season_tournaments' season.id %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    {% if mensagem %}
        <div class="alert alert-success d-flex align-items-center" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i> {{ mensagem }}
        </div>
    {% endif %}
    {% if mensagem_erro %}
        <div class="alert alert-danger d-flex align-items-center" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> {{ mensagem_erro }}
        </div>
    {% endif %}
    {% if edicao_bloqueada %}
        <div class="alert alert-warning d-flex align-items-center" role="alert">
            <i class="bi bi-lock-fill me-2"></i> Torneio finalizado ou cancelado. Edição bloqueada.
        </div>
    {% endif %}

    <form method="POST">
        {% csrf_token %}

        <div class="row g-4">
            
            <div class="col-lg-8">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i> Lista de Inscritos</h5>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-center" style="width: 50px;">
                                        <i class="bi bi-trash"></i>
                                    </th>
                                    <th>Jogador</th>
                                    <th>Solicitação</th>
                                    <th>Produtos</th>
                                    {% if tournament.permite_rebuy %}<th class="text-center">Rebuy</th>{% endif %}
                                    {% if tournament.permite_rebuy_duplo %}<th class="text-center">Rebuy Duplo</th>{% endif %}
                                    {% if tournament.permite_addon %}<th class="text-center">Add-on</th>{% endif %}
                                    {% if tournament.timechip_chips %}<th class="text-center">Time Chip</th>{% endif %}
                                    <th class="text-center">Confirmado?</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in entries %}
                                    <tr class="{% if entry.confirmado_pelo_admin %}table-success-subtle{% elif entry.confirmou_presenca %}table-warning-subtle{% endif %}">
                                        <td class="text-center">
                                            <input class="form-check-input border-danger" type="checkbox" name="remover_entry_id" value="{{ entry.id }}" 
                                                   {% if edicao_bloqueada %}disabled{% endif %}>
                                        </td>
                                        <td>
                                            <span class="fw-bold text-dark">{{ entry.player.nome }}</span>
                                            {% if entry.player.apelido %}
                                                <small class="text-muted d-block">({{ entry.player.apelido }})</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if entry.confirmou_presenca %}
                                                <span class="badge text-bg-warning">Pediu vaga</span>
                                            {% else %}
                                                <span class="text-muted small">Inserido pelo Admin</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="products-badge">
                                                {% if entry.product_purchases %}
                                                    {% for product in products %}
                                                        {% if product.id in entry.product_purchases %}
                                                            {% if product.nome not in "REBUY,REBUY_DUPLO,ADDON,STAFF,TIME_CHIP" %}
                                                            <span class="badge bg-success product-badge">
                                                                <i class="bi bi-check-lg"></i> {{ product.nome }}
                                                            </span>
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endif %}
                                            </div>
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-secondary btn-sm"
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#produtosModal"
                                                    data-player-id="{{ entry.player.id }}"
                                                    data-player-name="{{ entry.player.nome }}"
                                                    {% if edicao_bloqueada %}disabled{% endif %}>
                                                <i class="bi bi-gift"></i> <span class="d-none d-sm-inline">Adicionar</span>
                                            </button>
                                        </td>
                                        {% if tournament.permite_rebuy %}
                                        <td class="text-center">
                                            <button type="button" class="btn btn-sm btn-outline-warning rebuy-btn"
                                                    data-tournament-id="{{ tournament.id }}"
                                                    data-player-id="{{ entry.player.id }}"
                                                    data-player-name="{{ entry.player.nome }}"
                                                    data-tipo="REBUY"
                                                    {% if edicao_bloqueada %}disabled{% endif %}>
                                                <i class="bi bi-arrow-clockwise"></i>
                                                {% with rebuy_count=entry.get_rebuy_count %}
                                                <span class="badge bg-danger rebuy-count-{{ entry.player.id }} badge-with-remove{% if not rebuy_count %} d-none{% endif %}" data-player-id="{{ entry.player.id }}" data-tournament-id="{{ tournament.id }}" data-tipo="REBUY" style="cursor: pointer; position: relative; padding-right: 18px;">
                                                    <span class="badge-text">{{ rebuy_count }}</span>
                                                    <span class="badge-remove" style="position: absolute; right: 2px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 12px; font-weight: bold;">✕</span>
                                                </span>
                                                {% endwith %}
                                            </button>
                                        </td>
                                        {% endif %}
                                        {% if tournament.permite_rebuy_duplo %}
                                        <td class="text-center">
                                            <button type="button" class="btn btn-sm btn-outline-warning rebuy-duplo-btn"
                                                    data-tournament-id="{{ tournament.id }}"
                                                    data-player-id="{{ entry.player.id }}"
                                                    data-player-name="{{ entry.player.nome }}"
                                                    data-tipo="REBUY_DUPLO"
                                                    title="Rebuy Duplo (2x ou valor diferenciado)"
                                                    {% if edicao_bloqueada %}disabled{% endif %}>
                                                <i class="bi bi-arrow-clockwise"></i>
                                                <i class="bi bi-arrow-clockwise"></i>
                                                {% with rebuy_duplo_count=entry.get_rebuy_duplo_count %}
                                                <span class="badge bg-dark rebuy-duplo-count-{{ entry.player.id }} badge-with-remove{% if not rebuy_duplo_count %} d-none{% endif %}" data-player-id="{{ entry.player.id }}" data-tournament-id="{{ tournament.id }}" data-tipo="REBUY_DUPLO" style="cursor: pointer; position: relative; padding-right: 18px;">
                                                    <span class="badge-text">{{ rebuy_duplo_count }}</span>
                                                    <span class="badge-remove" style="position: absolute; right: 2px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 12px; font-weight: bold;">✕</span>
                                                </span>
                                                {% endwith %}
                                            </button>
                                        </td>
                                        {% endif %}
                                        {% if tournament.permite_addon %}
                                        <td class="text-center">
                                            <button type="button" class="btn btn-sm btn-outline-info addon-btn"
                                                    data-tournament-id="{{ tournament.id }}"
                                                    data-player-id="{{ entry.player.id }}"
                                                    data-player-name="{{ entry.player.nome }}"
                                                    data-tipo="ADDON"
                                                    {% if edicao_bloqueada %}disabled{% endif %}>
                                                <i class="bi bi-plus-lg"></i>
                                                {% with addon_count=entry.get_addon_count %}
                                                <span class="badge bg-success addon-count-{{ entry.player.id }} badge-with-remove{% if not addon_count %} d-none{% endif %}" data-player-id="{{ entry.player.id }}" data-tournament-id="{{ tournament.id }}" data-tipo="ADDON" style="cursor: pointer; position: relative; padding-right: 18px;">
                                                    <span class="badge-text">{{ addon_count }}</span>
                                                    <span class="badge-remove" style="position: absolute; right: 2px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 12px; font-weight: bold;">✕</span>
                                                </span>
                                                {% endwith %}
                                            </button>
                                        </td>
                                        {% endif %}
                                        {% if tournament.timechip_chips %}
                                        <td class="text-center">
                                            <button type="button" class="btn btn-sm btn-outline-success timechip-btn"
                                                    data-tournament-id="{{ tournament.id }}"
                                                    data-player-id="{{ entry.player.id }}"
                                                    data-player-name="{{ entry.player.nome }}"
                                                    data-tipo="TIME_CHIP"
                                                    title="Time Chip - Jogador chegou a tempo"
                                                    {% if edicao_bloqueada %}disabled{% endif %}>
                                                <i class="bi bi-clock-fill"></i>
                                                {% with timechip_count=entry.get_timechip_count %}
                                                <span class="badge bg-success timechip-count-{{ entry.player.id }} badge-with-remove{% if not timechip_count %} d-none{% endif %}" data-player-id="{{ entry.player.id }}" data-tournament-id="{{ tournament.id }}" data-tipo="TIME_CHIP" style="cursor: pointer; position: relative; padding-right: 18px;">
                                                    <span class="badge-text">{{ timechip_count }}</span>
                                                    <span class="badge-remove" style="position: absolute; right: 2px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 12px; font-weight: bold;">✕</span>
                                                </span>
                                                {% endwith %}
                                            </button>
                                        </td>
                                        {% endif %}
                                        <td class="text-center">
                                            <div class="form-check form-switch d-inline-block">
                                                <input class="form-check-input" type="checkbox" name="conf_admin_{{ entry.id }}" 
                                                       {% if entry.confirmado_pelo_admin %}checked{% endif %}
                                                       {% if edicao_bloqueada %}disabled{% endif %}>
                                            </div>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center py-5 text-muted">
                                            Nenhum jogador inscrito neste torneio.
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="card-footer bg-light d-flex justify-content-between p-3 flex-wrap gap-2">
                        <button type="submit" name="remove_selected" class="btn btn-outline-danger btn-sm"
                                onclick="return confirm('Remover os jogadores selecionados?');"
                                {% if edicao_bloqueada %}disabled{% endif %}>
                            <i class="bi bi-trash"></i> Remover Selecionados
                        </button>

                        <div class="d-flex gap-2">
                            <button type="submit" name="confirm_all_requests" class="btn btn-warning btn-sm fw-bold text-dark"
                                    {% if edicao_bloqueada %}disabled{% endif %}>
                                <i class="bi bi-check-all"></i> Confirmar Pedidos
                            </button>
                            <button type="submit" name="save_admin_confirm" class="btn btn-primary btn-sm fw-bold"
                                    {% if edicao_bloqueada %}disabled{% endif %}>
                                <i class="bi bi-save"></i> Salvar Alterações
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm border-0 sticky-top" style="top: 20px;">
                    <div class="card-header bg-success text-white py-3">
                        <h5 class="mb-0"><i class="bi bi-person-plus-fill me-2"></i> Adicionar Manualmente</h5>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted mb-3">Insira um jogador diretamente no torneio (sem que ele precise pedir).</p>
                        
                        <div class="mb-3">
                            <label for="novo_player_id" class="form-label fw-bold">Selecione o Jogador</label>
                            <select class="form-select" name="novo_player_id" id="novo_player_id" {% if entrada_bloqueada %}disabled{% endif %}>
                                <option value="">Buscar jogador...</option>
                                {% for p in players_disponiveis %}
                                    <option value="{{ p.id }}">{{ p.nome }} {% if p.apelido %}({{ p.apelido }}){% endif %}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" name="add_player" class="btn btn-success fw-bold"
                                    {% if entrada_bloqueada %}disabled{% endif %}>
                                <i class="bi bi-plus-lg"></i> Adicionar
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#modalNovoJogador"
                                    {% if edicao_bloqueada %}disabled{% endif %}>
                                <i class="bi bi-person-check"></i> Criar Novo Jogador
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </form>
</div>

<!-- Modal para Adicionar Produtos -->
<div class="modal fade" id="produtosModal" tabindex="-1" aria-labelledby="produtosModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="produtosModalLabel">
                    <i class="bi bi-gift"></i> Adicionar Produtos - <span id="playerNameModal"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Selecione os produtos que este jogador adquiriu
                </div>
                <form id="productForm" method="POST" action="{% url 'tournament_entries_manage' tournament.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="add_products" value="1">
                    <input type="hidden" id="playerId" name="player_id" value="">
                    
                    <div class="row g-3">
                        {% for product in products %}
                        <div class="col-md-6">
                            <div class="form-check">
                                <input 
                                    class="form-check-input product-checkbox" 
                                    type="checkbox" 
                                    name="products" 
                                    value="{{ product.id }}" 
                                    id="product_{{ product.id }}"
                                    data-product-name="{{ product.nome }}"
                                    data-product-price="{{ product.valor }}">
                                <label class="form-check-label w-100" for="product_{{ product.id }}">
                                    <div class="fw-bold">{{ product.nome }}</div>
                                    <small class="text-muted">R$ {{ product.valor|floatformat:2 }}</small>
                                    {% if product.descricao %}
                                        <div class="small text-muted">{{ product.descricao }}</div>
                                    {% endif %}
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="mt-4 p-3 bg-light rounded">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Total de Produtos:</h6>
                            <span class="badge bg-primary fs-6" id="totalProducts">R$ 0,00</span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" form="productForm" class="btn btn-success">
                    <i class="bi bi-plus-lg"></i> Adicionar Produtos
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('produtosModal');
    const playerId = document.getElementById('playerId');
    const playerNameModal = document.getElementById('playerNameModal');
    const productCheckboxes = document.querySelectorAll('.product-checkbox');
    const totalProducts = document.getElementById('totalProducts');

    // Atualizar total quando checkbox é clicado
    productCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateTotal();
        });
    });

    function updateTotal() {
        let total = 0;
        productCheckboxes.forEach(checkbox => {
            if (checkbox.checked) {
                total += parseFloat(checkbox.dataset.productPrice) || 0;
            }
        });
        totalProducts.textContent = 'R$ ' + total.toFixed(2).replace('.', ',');
    }

    // Quando o modal é aberto
    modal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const id = button.dataset.playerId;
        const name = button.dataset.playerName;
        
        playerId.value = id;
        playerNameModal.textContent = name;

        // Desmarcar todos os checkboxes
        productCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        
        updateTotal();
    });
});
</script>

<!-- MODAL: Criar Novo Jogador -->
<div class="modal fade" id="modalNovoJogador" tabindex="-1" aria-labelledby="modalNovoJogadorLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="modalNovoJogadorLabel">
                    <i class="bi bi-person-plus-fill"></i> Novo Jogador
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formNovoJogador">
                {% csrf_token %}
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label for="inputNomeJogador" class="form-label">Nome Completo</label>
                        <input type="text" class="form-control" id="inputNomeJogador" name="nome" 
                               placeholder="Ex: João da Silva" required>
                    </div>

                    <div class="mb-3">
                        <label for="inputApelidoJogador" class="form-label">Apelido (Como será chamado)</label>
                        <input type="text" class="form-control" id="inputApelidoJogador" name="apelido" 
                               placeholder="Ex: João">
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="inputCpfJogador" class="form-label">CPF</label>
                            <input type="text" class="form-control" id="inputCpfJogador" name="cpf" 
                                   placeholder="000.000.000-00">
                        </div>
                        <div class="col-md-6">
                            <label for="inputTelefoneJogador" class="form-label">Telefone / WhatsApp</label>
                            <input type="tel" class="form-control" id="inputTelefoneJogador" name="telefone" 
                                   placeholder="(00) 00000-0000">
                        </div>
                    </div>

                    <div class="mb-4 pt-2 border-top">
                        <div class="form-check form-switch mt-3">
                            <input class="form-check-input" type="checkbox" id="inputCriarUsuario" name="criar_usuario">
                            <label class="form-check-label fw-bold" for="inputCriarUsuario">
                                Criar usuário de acesso?
                            </label>
                            <div class="form-text">Deixe desmarcado se for apenas um jogador de passagem.</div>
                        </div>
                    </div>

                    <div id="camposUsuario" style="display: none;">
                        <div class="mb-3">
                            <label for="inputUsernameJogador" class="form-label">
                                Username
                            </label>
                            <input type="text" class="form-control" id="inputUsernameJogador" name="username" 
                                   placeholder="Ex: joao_silva">
                            <small class="form-text text-muted">Identificador único para login (sem espaços)</small>
                        </div>

                        <div class="mb-3">
                            <label for="inputEmailJogador" class="form-label">
                                Email
                            </label>
                            <input type="email" class="form-control" id="inputEmailJogador" name="email" 
                                   placeholder="Ex: joao@email.com">
                            <small class="form-text text-muted">Para login e notificações</small>
                        </div>
                    </div>

                    <div id="alertErroJogador" class="alert alert-danger d-none" role="alert"></div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-arrow-left"></i> Voltar
                    </button>
                    <button type="submit" class="btn btn-primary px-5 fw-bold rounded-pill" id="btnCriarJogador">
                        SALVAR
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// ============================================================
// MODAL: Criar Novo Jogador
// ============================================================
document.addEventListener('DOMContentLoaded', function() {
    const formNovoJogador = document.getElementById('formNovoJogador');
    if (!formNovoJogador) {
        console.log('Form não encontrado - pulando inicialização');
        return;
    }

    const toggleCriarUsuario = document.getElementById('inputCriarUsuario');
    const camposUsuario = document.getElementById('camposUsuario');

    // Mostrar/esconder campos de usuário quando checkbox muda
    if (toggleCriarUsuario && camposUsuario) {
        toggleCriarUsuario.addEventListener('change', function() {
            if (this.checked) {
                camposUsuario.style.display = 'block';
                const usernameField = document.getElementById('inputUsernameJogador');
                if (usernameField) usernameField.focus();
            } else {
                camposUsuario.style.display = 'none';
                const usernameField = document.getElementById('inputUsernameJogador');
                const emailField = document.getElementById('inputEmailJogador');
                if (usernameField) usernameField.value = '';
                if (emailField) emailField.value = '';
            }
        });
    }
    
    formNovoJogador.addEventListener('submit', async function(e) {
        e.preventDefault();
    
    const nome = document.getElementById('inputNomeJogador').value.trim();
    const apelido = document.getElementById('inputApelidoJogador').value.trim();
    const cpf = document.getElementById('inputCpfJogador').value.trim();
    const telefone = document.getElementById('inputTelefoneJogador').value.trim();
    const criarUsuario = document.getElementById('inputCriarUsuario').checked;
    const username = document.getElementById('inputUsernameJogador').value.trim();
    const email = document.getElementById('inputEmailJogador').value.trim();
    const alertError = document.getElementById('alertErroJogador');
    const btnCriar = document.getElementById('btnCriarJogador');
    
    // Limpar alerta
    alertError.classList.add('d-none');
    alertError.innerHTML = '';
    
    // Validação básica - apenas Nome é obrigatório
    if (!nome) {
        alertError.innerHTML = '<i class="bi bi-exclamation-circle"></i> Por favor, preencha o nome do jogador.';
        alertError.classList.remove('d-none');
        return;
    }

    // Se vai criar usuário, validar os campos
    if (criarUsuario) {
        if (!username || !email) {
            alertError.innerHTML = '<i class="bi bi-exclamation-circle"></i> Para criar usuário, preencha username e email.';
            alertError.classList.remove('d-none');
            return;
        }

        if (username.includes(' ')) {
            alertError.innerHTML = '<i class="bi bi-exclamation-circle"></i> Username não pode conter espaços.';
            alertError.classList.remove('d-none');
            return;
        }
    }

    btnCriar.disabled = true;
    btnCriar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>SALVANDO...';

    try {
        const response = await fetch('{% url "player_create_quick" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                nome: nome,
                apelido: apelido || null,
                cpf: cpf || null,
                telefone: telefone || null,
                username: criarUsuario ? username : null,
                email: criarUsuario ? email : null
            })
        });

        const data = await response.json();

        if (response.ok && data.success) {
            // Adicionar novo jogador ao select
            const select = document.getElementById('novo_player_id');
            const option = document.createElement('option');
            option.value = data.player_id;
            option.textContent = data.player_nome + (data.player_apelido ? ' (' + data.player_apelido + ')' : '');
            select.appendChild(option);
            
            // Selecionar o novo jogador
            select.value = data.player_id;
            
            // Fechar modal
            const modalElement = document.getElementById('modalNovoJogador');
            if (modalElement) {
                let modal = bootstrap.Modal.getInstance(modalElement);
                if (!modal) {
                    modal = new bootstrap.Modal(modalElement);
                }
                modal.hide();
            }
            
            // Resetar formulário
            document.getElementById('formNovoJogador').reset();
            toggleCriarUsuario.checked = false;
            camposUsuario.style.display = 'none';
            
            // Mostrar mensagem de sucesso
            const successAlert = document.createElement('div');
            successAlert.className = 'alert alert-success alert-dismissible fade show';
            const userInfo = data.tem_usuario ? ' (com acesso de login)' : ' (jogador de passagem)';
            successAlert.innerHTML = `
                <i class="bi bi-check-circle-fill"></i> Jogador <strong>${data.player_nome}</strong> criado com sucesso${userInfo}! 
                Clique em "Adicionar" para adicioná-lo ao torneio.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(successAlert, document.querySelector('script'));
            
            // Auto-remover após 5 segundos
            setTimeout(() => successAlert.remove(), 5000);
        } else {
            alertError.innerHTML = `<i class="bi bi-exclamation-circle"></i> ${data.error || 'Erro ao criar jogador.'}`;
            alertError.classList.remove('d-none');
        }
    } catch (error) {
        alertError.innerHTML = '<i class="bi bi-exclamation-circle"></i> Erro ao criar jogador. Tente novamente.';
        alertError.classList.remove('d-none');
        console.error('Erro:', error);
    } finally {
        btnCriar.disabled = false;
        btnCriar.innerHTML = 'SALVAR';
    }
    }); // Fecha addEventListener do form
}); // Fecha DOMContentLoaded

// ============================================================
// REBUY E ADD-ON BUTTONS - COM DELEGAÇÃO DE EVENTO
// ============================================================
document.addEventListener('DOMContentLoaded', function() {
    // Procurar todos os botões
    const rebuBtns = document.querySelectorAll('button.rebuy-btn');
    const rebuyDuploBtns = document.querySelectorAll('button.rebuy-duplo-btn');
    const addonBtns = document.querySelectorAll('button.addon-btn');
    const timeChipBtns = document.querySelectorAll('button.timechip-btn');
    
    // Adicionar listeners a cada botão
    [...rebuBtns, ...rebuyDuploBtns, ...addonBtns, ...timeChipBtns].forEach((btn) => {
        btn.addEventListener('click', handleRebuyAddonClick);
    });
    
    // Adicionar listeners aos badges com X (remover)
    document.querySelectorAll('.badge-with-remove').forEach((badge) => {
        badge.addEventListener('click', handleRemoveBadgeClick);
    });
});

async function handleRemoveBadgeClick(e) {
    e.preventDefault();
    e.stopPropagation();
    
    // Sempre remover quando clicar no badge (com a classe badge-with-remove)
    const badge = this;
    const playerId = badge.dataset.playerId;
    const tournamentId = badge.dataset.tournamentId;
    const tipo = badge.dataset.tipo;
    
    try {
        const endpoint = `/api/torneio/${tournamentId}/rebuy-addon/remove/`;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        const payload = {
            player_id: parseInt(playerId),
            tipo: tipo
        };
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Atualizar badge com nova quantidade
            const badgeTextEl = badge.querySelector('.badge-text');
            if (badgeTextEl) {
                if (data.quantidade > 0) {
                    badgeTextEl.textContent = data.quantidade;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
            
            showNotification(data.message, 'success');
        } else {
            showNotification(data.error || 'Erro ao remover', 'danger');
        }
    } catch (error) {
        showNotification('Erro: ' + error.message, 'danger');
    }
}

async function handleRebuyAddonClick(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const btn = this;
    const tournamentId = btn.dataset.tournamentId;
    const playerId = btn.dataset.playerId;
    const playerName = btn.dataset.playerName;
    const tipo = btn.dataset.tipo;
    
    if (!tournamentId || !playerId || !tipo) {
        alert('Erro: Dados incompletos');
        return;
    }
    
    // Salvar todos os ícones originais (pode haver múltiplos para rebuy duplo)
    const originalIcons = btn.querySelectorAll('i');
    const originalIconsHTML = Array.from(originalIcons).map(i => i.outerHTML).join('');
    
    // Desabilitar botão e mostrar spinner
    btn.disabled = true;
    const spinner = '<span class="spinner-border spinner-border-sm"></span>';
    
    // Manter os badges existentes
    const badgesHTML = Array.from(btn.querySelectorAll('.badge'))
        .map(badge => badge.outerHTML)
        .join('');
    
    btn.innerHTML = spinner + badgesHTML;
    
    try {
        const endpoint = `/api/torneio/${tournamentId}/rebuy-addon/`;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        const payload = {
            player_id: parseInt(playerId),
            tipo: tipo
        };
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Atualizar contador
            let counterClass;
            if (tipo === 'REBUY') {
                counterClass = `rebuy-count-${playerId}`;
            } else if (tipo === 'REBUY_DUPLO') {
                counterClass = `rebuy-duplo-count-${playerId}`;
            } else if (tipo === 'ADDON') {
                counterClass = `addon-count-${playerId}`;
            } else if (tipo === 'TIME_CHIP') {
                counterClass = `timechip-count-${playerId}`;
            }
            
            let counter = document.querySelector(`.${counterClass}`);
            
            if (counter) {
                // Remover classe d-none se tiver (para badges que começam invisíveis)
                counter.classList.remove('d-none');
                counter.style.display = 'inline-block';
                
                // Atualizar apenas o texto dentro do badge, não o badge inteiro
                const badgeText = counter.querySelector('.badge-text');
                if (badgeText) {
                    badgeText.textContent = data.quantidade;
                } else {
                    counter.textContent = data.quantidade;
                }
            } else {
                // Criar badge se não existir
                const buttonSelector = tipo === 'REBUY' ? '.rebuy-btn' : 
                                       tipo === 'REBUY_DUPLO' ? '.rebuy-duplo-btn' : 
                                       tipo === 'ADDON' ? '.addon-btn' :
                                       '.timechip-btn';
                
                const buttons = document.querySelectorAll(`button${buttonSelector}[data-player-id="${playerId}"]`);
                
                if (buttons.length > 0) {
                    const button = buttons[0];
                    counter = button.querySelector(`.${counterClass}`);
                    
                    if (!counter) {
                        counter = document.createElement('span');
                        
                        // Determinar cores e classes baseado no tipo
                        let bgClass, bgColor;
                        if (tipo === 'REBUY') {
                            bgClass = 'bg-danger';
                            bgColor = '#dc3545';
                        } else if (tipo === 'REBUY_DUPLO') {
                            bgClass = 'bg-dark';
                            bgColor = '#212529';
                        } else if (tipo === 'ADDON') {
                            bgClass = 'bg-success';
                            bgColor = '#198754';
                        } else if (tipo === 'TIME_CHIP') {
                            bgClass = 'bg-success';
                            bgColor = '#198754';
                        }
                        
                        // Criar estrutura com badge-text e badge-remove
                        counter.className = `badge ${bgClass} ${counterClass} badge-with-remove`;
                        counter.setAttribute('data-player-id', playerId);
                        counter.setAttribute('data-tournament-id', tournamentId);
                        counter.setAttribute('data-tipo', tipo);
                        counter.setAttribute('style', 'cursor: pointer; position: relative; padding-right: 18px; display: inline-block; margin-left: 4px;');
                        
                        // HTML interno
                        counter.innerHTML = `
                            <span class="badge-text">${data.quantidade}</span>
                            <span class="badge-remove" style="position: absolute; right: 2px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 12px; font-weight: bold;">✕</span>
                        `;
                        
                        // Adicionar listener de click para remover
                        counter.addEventListener('click', handleRemoveBadgeClick);
                        
                        button.appendChild(counter);
                    } else {
                        // Atualizar apenas o texto dentro do badge
                        const badgeText = counter.querySelector('.badge-text');
                        if (badgeText) {
                            badgeText.textContent = data.quantidade;
                        } else {
                            counter.textContent = data.quantidade;
                        }
                        counter.style.display = 'inline-block';
                    }
                } else {
                    console.warn(`Nenhum botão encontrado para player ${playerId} com tipo ${tipo}`);
                }
            }
            
            showNotification(data.message, 'success');
        } else {
            showNotification(data.error || 'Erro ao adicionar', 'danger');
        }
    } catch (error) {
        showNotification('Erro: ' + error.message, 'danger');
    } finally {
        // Restaurar botão com ícones + badges mantidos
        const badgesHTML = Array.from(btn.querySelectorAll('.badge'))
            .map(badge => badge.outerHTML)
            .join('');
        
        btn.disabled = false;
        btn.innerHTML = originalIconsHTML + badgesHTML;
    }
}

function showNotification(message, type) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.style.margin = '10px';
    alert.innerHTML = `
        <i class="bi bi-${type === 'success' ? 'check-circle-fill' : 'exclamation-circle'}"></i> 
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Adicionar ao body - simples e seguro
    document.body.appendChild(alert);
    
    // Auto-remover após 4 segundos
    setTimeout(() => {
        try {
            alert.remove();
        } catch (e) {
        }
    }, 4000);
}
</script>

<!-- Modal: Mudar Status do Torneio -->
<div class="modal fade" id="modalMudarStatus" tabindex="-1" aria-labelledby="modalMudarStatusLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="modalMudarStatusLabel">
                    <i class="bi bi-pencil-square me-2"></i> Alterar Status do Torneio
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form id="formMudarStatus" method="POST" action="{% url 'tournament_update_status' tournament.id %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="selectStatus" class="form-label">Selecione o novo status:</label>
                        <select class="form-select form-select-lg" id="selectStatus" name="status" required>
                            <option value="">-- Escolha uma opção --</option>
                            {% if tournament.status != "EM_ANDAMENTO" %}
                            <option value="EM_ANDAMENTO">
                                <i class="bi bi-play-circle"></i> Iniciar Torneio
                            </option>
                            {% endif %}
                            {% if tournament.status != "FINALIZADO" %}
                            <option value="FINALIZADO">
                                <i class="bi bi-stop-circle"></i> Finalizar Torneio
                            </option>
                            {% endif %}
                            {% if tournament.status != "CANCELADO" %}
                            <option value="CANCELADO">
                                <i class="bi bi-x-circle"></i> Cancelar Torneio
                            </option>
                            {% endif %}
                        </select>
                        <small class="form-text text-muted d-block mt-2">
                            <i class="bi bi-info-circle"></i> 
                            Status atual: <strong>{{ tournament.get_status_display }}</strong>
                        </small>
                    </div>
                    <div class="alert alert-info" role="alert">
                        <i class="bi bi-lightbulb me-2"></i>
                        <strong>Nota:</strong> Mudanças de status afetarão a disponibilidade de funcionalidades do torneio.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="btnConfirmarMudarStatus">
                    <i class="bi bi-check-lg me-1"></i> Confirmar Mudança
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Confirmar mudança de status com AJAX
document.getElementById('btnConfirmarMudarStatus').addEventListener('click', async function() {
    const selectStatus = document.getElementById('selectStatus');
    const novoStatus = selectStatus.value;
    
    if (!novoStatus) {
        alert('Por favor, selecione um status.');
        return;
    }
    
    const form = document.getElementById('formMudarStatus');
    const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;
    
    try {
        const response = await fetch(form.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ status: novoStatus })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Status alterado com sucesso!', 'success');
            // Atualizar a página após 1 segundo
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showNotification(data.error || 'Erro ao alterar status.', 'danger');
        }
    } catch (error) {
        showNotification('Erro: ' + error.message, 'danger');
    }
});
</script>

{% endblock %}